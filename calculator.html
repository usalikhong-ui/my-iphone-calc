<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ABCDE æœˆæ›†ï¼ˆå‚™è¨»ç‰ˆï¼‰</title>
<style>
  :root{
    --bg: #0b1220;
    --panel: rgba(255,255,255,.08);
    --card: rgba(255,255,255,.12);
    --stroke: rgba(255,255,255,.18);
    --txt: #f6f7fb;
    --muted: #c5cbd6;
    --accent: #7dd3fc;
    --today: #ffd166;
    --weekbar: #364156;
    --holiday: #e11d48;
    --marker-blue: #3b82f6;
    --marker-green: #22c55e;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang HK",
        "Noto Sans HK","Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;
        background: linear-gradient(180deg, #0a0f19, #0b1220 30%, #0b1220 100%); color:var(--txt); }
  header{ position:sticky; top:0; z-index:5; background: rgba(11,18,32,.75);
          backdrop-filter: blur(10px); border-bottom:1px solid var(--stroke); }
  .wrap{ max-width:1100px; margin:0 auto; padding:12px; }
  
  .top-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
  }
  .top-filters {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .chip-group {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }
  /* --- ä¿®æ”¹ï¼šæŒ‰éˆ•ä½ˆå±€ --- */
  .button-group {
    display: flex;
    gap: 10px;
    margin-left: auto; /* å°‡æ‰€æœ‰æŒ‰éˆ•æ¨åˆ°æœ€å³ */
    flex-shrink: 0;
  }
  .btn-add-marker {
    padding: 6px 10px;
    font-size: 13px;
    background: var(--accent);
    color: var(--bg);
    border: none;
  }
  .btn-help {
    padding: 6px 10px;
    font-size: 13px;
  }
  
  .title {
    flex-grow: 1;
    text-align: center;
  }
  
  .navbtn{ 
    background: var(--panel); border:1px solid var(--stroke); padding:8px;
    border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink: 0;
  }
  .title{ font-weight:700; letter-spacing:.5px; padding:6px 10px; border-radius:10px; background:var(--panel); border:1px solid var(--stroke); }
  input[type="month"]{ background:transparent; color:var(--txt); border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px; outline:none; flex-shrink: 0; }
  .chip{ padding:6px 12px; border-radius:999px; background: var(--panel); border:1px solid var(--stroke); cursor:pointer; user-select:none; }
  .chip[data-on="1"]{ outline:2px solid var(--accent); }
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--panel); color:var(--txt); cursor:pointer; }
  .btn:hover{ outline:2px solid var(--accent); }
  
  .weekbar{ display:grid; grid-template-columns: repeat(7,1fr); background: var(--weekbar); border-radius:10px; overflow:hidden; margin-top:10px; }
  .weekbar div{ text-align:center; padding:8px 0; font-size:12px; color:#e7eaf1; transition: color 0.2s; }
  .weekbar div.is-today {
    color: var(--today);
    font-weight: 700;
  }
  
  .grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:6px; margin-top:8px; }
  .cell{ min-height:120px; background: var(--card); border:1px solid var(--stroke); border-radius:10px; padding:8px;
         display:flex; flex-direction:column; gap:6px; transition: opacity .2s, border-color .2s; cursor:pointer; }
  .cell.dim{ opacity:.35; }
  
  .cell.filtered-dim { opacity: .35; }
  
  .dhead{ display:flex; align-items:center; justify-content:space-between; }
  .dnum{ font-weight:700; }
  .dnum.today{ outline:2px solid var(--today); border-radius:8px; padding:2px 6px; }

  .cell.is-holiday {
    border-left: 3px solid var(--holiday);
    padding-left: 6px;
  }
  .cell.is-marker {
    border-left-width: 3px;
    padding-left: 6px;
  }

  .trip{ display:flex; flex-direction:column; gap:2px; }
  .code{ font-weight:800; letter-spacing:.3px; }
  .A{ color:#3b82f6;} .B{ color:#f59e0b;} .C{ color:#22c55e;} .D{ color:#8b5cf6;} .E{ color:#fb7185;}
  .notes-input{
    margin-top:auto;
    width:100%;
    background: var(--panel);
    border:1px solid var(--stroke);
    border-radius:6px;
    color: var(--txt);
    padding:4px 6px;
    font-size:11px;
    outline: none;
    cursor:text;
  }
  .notes-input::placeholder{ color: var(--muted); opacity: 0.6; }
  .notes-input:focus{ outline:1px solid var(--accent); }

  .modal-backdrop {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity .2s;
  }
  .modal-backdrop.show {
    opacity: 1; pointer-events: auto;
  }
  .modal-content {
    background: #1c2536;
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
    max-width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .modal-content p {
    text-align: center;
    margin-top: 0;
  }
  .modal-content button {
    margin-top: 15px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .modal-content h3 {
    margin-top: 0;
    text-align: left;
  }
  /* --- æ–°å¢ï¼šHelp Modal æ¨£å¼ --- */
  .modal-content ul {
    text-align: left;
    padding-left: 20px;
    color: var(--muted);
  }
  .modal-content li {
    margin-bottom: 10px;
    line-height: 1.5;
  }
  .modal-content code {
    background: var(--panel);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 15px;
    text-align: left;
  }
  .form-group label {
    font-size: 13px;
    color: var(--muted);
  }
  .form-group input, .form-group select {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    padding: 8px 10px;
    color: var(--txt);
    outline: none;
  }
  .form-group input:focus, .form-group select:focus {
    outline: 1px solid var(--accent);
  }
  .color-select {
    display: flex;
    gap: 10px;
  }
  .color-select label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .color-dot {
    width: 16px; height: 16px;
    border-radius: 50%;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .modal-actions button.secondary {
    background: var(--panel);
    color: var(--txt);
  }
  
  @keyframes bounce-in-right {
      0% { transform: translateX(100%); opacity: 0; }
      60% { transform: translateX(-10%); opacity: 1; }
      80% { transform: translateX(5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-left {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
  }
  @keyframes bounce-in-left {
      0% { transform: translateX(-100%); opacity: 0; }
      60% { transform: translateX(10%); opacity: 1; }
      80% { transform: translateX(-5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-right {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
  }

  .grid.animate-in-right { animation: bounce-in-right 0.4s ease-out forwards; }
  .grid.animate-out-left { animation: bounce-out-left 0.4s ease-out forwards; }
  .grid.animate-in-left { animation: bounce-in-left 0.4s ease-out forwards; }
  .grid.animate-out-right { animation: bounce-out-right 0.4s ease-out forwards; }
  
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top-controls">
      <button class="navbtn" id="prevM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <div class="title" id="title"></div>
      <button class="navbtn" id="nextM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
      <input type="month" id="monthPick">
    </div>
    <div class="top-filters">
      <div class="chip-group">
        <div class="chip" data-on="0" data-letter="A">A</div>
        <div class="chip" data-on="0" data-letter="B">B</div>
        <div class="chip" data-on="0" data-letter="C">C</div>
        <div class="chip" data-on="0" data-letter="D">D</div>
        <div class="chip" data-on="0" data-letter="E">E</div>
      </div>
      <!-- --- ä¿®æ”¹ï¼šæŒ‰éˆ• group --- -->
      <div class="button-group">
        <button class="btn btn-help" id="btnHelp">èªªæ˜</button>
        <button class="btn btn-add-marker" id="btnAddMarker">+ æ¨™è¨˜</button>
        <button class="btn" id="btnExportText">è¼¸å‡ºæ–‡å­—</button>
        <button class="btn" id="btnExport">è¼¸å‡º CSV</button>
      </div>
    </div>
    <div class="weekbar" id="weekbar">
      <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
  </div>
</header>

<main class="wrap" id="mainWrap">
  <div class="grid" id="grid"></div>
</main>

<div class="modal-backdrop" id="customAlert">
  <div class="modal-content">
    <p id="customAlertMsg"></p>
    <button id="customAlertClose">æ˜ç™½</button>
  </div>
</div>

<div class="modal-backdrop" id="markerModal">
  <div class="modal-content">
    <h3>æ–°å¢è‡ªè¨‚æ¨™è¨˜</h3>
    <div class="form-group">
      <label for="markerDate">æ—¥æœŸ</label>
      <input type="date" id="markerDate">
    </div>
    <div class="form-group">
      <label for="markerDesc">èªªæ˜</label>
      <input type="text" id="markerDesc" placeholder="e.g. è¦†è¨º">
    </div>
    <div class="form-group">
      <label>é¡è‰²</label>
      <div class="color-select">
        <label>
          <input type="radio" name="markerColor" value="blue" checked>
          <span class="color-dot" style="background: var(--marker-blue);"></span> è—è‰²
        </label>
        <label>
          <input type="radio" name="markerColor" value="green">
          <span class="color-dot" style="background: var(--marker-green);"></span> ç¶ è‰²
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="secondary" id="btnCancelMarker">å–æ¶ˆ</button>
      <button id="btnSaveMarker">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- --- æ–°å¢ï¼šHelp Modal --- -->
<div class="modal-backdrop" id="helpModal">
  <div class="modal-content">
    <h3>ä½¿ç”¨èªªæ˜</h3>
    <ul>
      <li><b>A-E ç¯©é¸</b>: é»æ“Š <code>A</code>-<code>E</code> ä»»ä½•ä¸€å€‹ï¼Œæ—¥æ›†æœƒé«˜äº®é¡¯ç¤ºæ‰€æœ‰åŒ…å«è©²å­—æ¯å˜…æ—¥å­ (e.g. ç¯©é¸ "D" æœƒé¡¯ç¤º "D1", "C1", "B1")ã€‚</li>
      <li><b>è‡ªå‹•å„²å­˜</b>: å–ºæ ¼ä»”åº•éƒ¨è¼¸å…¥å˜…ã€Œå‚™è¨»ã€æœƒè‡ªå‹•å„²å­˜å–ºä½ å˜…ç€è¦½å™¨ï¼Œä¸‹æ¬¡é–‹è¿”éƒ½æœƒå–ºåº¦ã€‚</li>
      <li><b>ç´…æ—¥å‡æœŸ</b>: å·¦é‚Šæœ‰ <code>ç´…è‰²</code>
        é‚Šå˜…ä¿‚é¦™æ¸¯å…¬çœ¾å‡æœŸï¼Œé»æ“Šæ ¼ä»”å¯ä»¥ç‡ä¿‚å’©å‡ã€‚</li>
      <li><b>è‡ªè¨‚æ¨™è¨˜</b>: é»æ“Š <code>+ æ¨™è¨˜</code>
        æ£ï¼Œå¯ä»¥æ€æ—¥æœŸã€é¡è‰² (è—/ç¶ ) åŒèªªæ˜ã€‚æ¨™è¨˜å’—å˜…æ—¥å­æœƒæœ‰é¡è‰²é‚Šï¼Œé»æ“Šæ ¼ä»”å¯ä»¥ç‡è¿”ä½ å˜…èªªæ˜ã€‚</li>
      <li><b>è¤‡è£½æ–‡å­—</b>: é»æ“Š <code>è¤‡è£½æ–‡å­—</code>
        æœƒå°‡ä½  *æ‰€æœ‰* å˜…å‚™è¨»åŒæ¨™è¨˜ï¼Œæ•´åˆæˆé©åˆ WhatsApp å˜…æ–‡å­—æ ¼å¼ï¼Œä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚</li>
      <li><b>è¼¸å‡º CSV</b>: é»æ“Š <code>è¼¸å‡º CSV</code>
        æœƒä¸‹è¼‰ä¸€å€‹ .csv æª”æ¡ˆï¼ŒåªåŒ…å« *æœ‰å‚™è¨»* å˜…æ—¥å­ï¼Œæ–¹ä¾¿å–º Excel æˆ– Google Sheets é–‹å•Ÿã€‚</li>
    </ul>
    <button id="btnCloseHelp">æ˜ç™½</button>
  </div>
</div>


<script>
// ---- å›ºå®šè¦å‰‡ï¼šä»Šæ—¥ 2025-11-09 = C6 ----
const LETTERS = ['A','B','C','D','E'];
const TODAY_ISO = '2025-11-09';
const ANCHOR_LETTER = 'C';
const ANCHOR_NUMBER = 6;

// ---- 2025 é¦™æ¸¯å…¬çœ¾å‡æœŸ ----
const HK_HOLIDAYS_2025 = new Map([
  ['2025-01-01', 'å…ƒæ—¦'],
  ['2025-01-29', 'è¾²æ›†å¹´åˆä¸€'],
  ['2025-01-30', 'è¾²æ›†å¹´åˆäºŒ'],
  ['2025-01-31', 'è¾²æ›†å¹´åˆä¸‰'],
  ['2025-04-04', 'æ¸…æ˜ç¯€'],
  ['2025-04-18', 'è€¶ç©Œå—é›£ç¯€'],
  ['2025-04-19', 'è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥'],
  ['2025-04-21', 'å¾©æ´»ç¯€æ˜ŸæœŸä¸€'],
  ['2025-05-01', 'å‹å‹•ç¯€'],
  ['2025-05-05', 'ä½›èª•'],
  ['2025-05-31', 'ç«¯åˆç¯€'],
  ['2025-07-01', 'é¦™æ¸¯ç‰¹å€æˆç«‹ç´€å¿µæ—¥'],
  ['2025-10-01', 'åœ‹æ…¶æ—¥'],
  ['2025-10-07', 'é‡é™½ç¯€ç¿Œæ—¥'], 
  ['2025-12-25', 'è–èª•ç¯€'],
  ['2025-12-26', 'è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥']
]);

// ---- Global æ•¸æ“šå„²å­˜ ----
let dailyNotes = {}; 
let customMarkers = {};

// ---- å„²å­˜/è®€å–åŠŸèƒ½ ----
function saveData() {
    try {
        localStorage.setItem('calendarNotes', JSON.stringify(dailyNotes));
        localStorage.setItem('calendarMarkers', JSON.stringify(customMarkers));
    } catch (e) {
        console.error('Failed to save data', e);
        showModal('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç©ºé–“å¯èƒ½å·²æ»¿ã€‚');
    }
}
function loadData() {
    const notes = localStorage.getItem('calendarNotes');
    const markers = localStorage.getItem('calendarMarkers');
    try {
      if (notes) {
          dailyNotes = JSON.parse(notes) || {};
      }
      if (markers) {
          customMarkers = JSON.parse(markers) || {};
      }
    } catch (e) {
      console.error('Failed to parse saved data', e);
      dailyNotes = {};
      customMarkers = {};
    }
}

// ---- å·¥å…·å‡½æ•¸ (ä¸è®Š) ----
function fmtISO(d){
  const y = d.getFullYear();
  const m = (d.getMonth() + 1).toString().padStart(2, '0');
  const day = d.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function daysBetween(aISO,bISO){ return Math.round((new Date(bISO)-new Date(aISO))/86400000); }
function mod(a,b){ return ((a % b)+b)%b; }

function letterNumFor(dateISO){
  const i0 = LETTERS.indexOf(ANCHOR_LETTER);
  const n = daysBetween(TODAY_ISO, dateISO);
  const idx = mod(i0 - n, 5);
  const wraps = Math.floor((i0 + n)/5);
  let num = ANCHOR_NUMBER + wraps;
  num = ((num - 1) % 10 + 10) % 10 + 1;
  return {letter: LETTERS[idx], number: num};
}
function triplet(letter, number){
  const i = LETTERS.indexOf(letter);
  return [`${LETTERS[i]}${number}`,`${LETTERS[(i+1)%5]}${number}`,`${LETTERS[(i+2)%5]}${number}`];
}
function firstCellDate(y, m){
  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  return new Date(y, m, 1 - startDow);
}
function currentFilter(){
  const chipElements = document.querySelectorAll('.chip');
  const set = new Set();
  for(const c of chipElements){ if(c.dataset.on==='1') set.add(c.dataset.letter); }
  return set;
}

// ---- Modal é¡¯ç¤º/éš±è— ----
function showModal(message) {
  const modal = document.getElementById('customAlert');
  const msg = document.getElementById('customAlertMsg');
  msg.textContent = message;
  modal.classList.add('show');
}
function closeModal() {
  const modal = document.getElementById('customAlert');
  modal.classList.remove('show');
}
function showMarkerModal(dateISO = '') {
    document.getElementById('markerDate').value = dateISO || fmtISO(new Date());
    document.getElementById('markerDesc').value = '';
    document.querySelector('input[name="markerColor"][value="blue"]').checked = true;
    document.getElementById('markerModal').classList.add('show');
}
function closeMarkerModal() {
    document.getElementById('markerModal').classList.remove('show');
}
// --- æ–°å¢ï¼šHelp Modal é¡¯ç¤º/éš±è— ---
function showHelpModal() {
    document.getElementById('helpModal').classList.add('show');
}
function closeHelpModal() {
    document.getElementById('helpModal').classList.remove('show');
}

// --- æ–°å¢ï¼šè¤‡è£½æ–‡å­—åŠŸèƒ½ ---
function copyToClipboard(text) {
    const ta = document.createElement('textarea');
    ta.style.position = 'absolute';
    ta.style.left = '-9999px';
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try {
        document.execCommand('copy');
        showModal('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    } catch (err) {
        console.error('Failed to copy text: ', err);
        showModal('è¤‡è£½å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
    document.body.removeChild(ta);
}

// ---- æ ¸å¿ƒ Render å‡½æ•¸ (ä¸è®Š) ----
function render(targetGrid, y, m_idx){
  const title = document.getElementById('title');
  targetGrid.innerHTML = '';
  if (isNaN(y) || isNaN(m_idx)) { return; }
  
  title.textContent = new Date(y, m_idx, 1).toLocaleString('zh-HK',{year:'numeric', month:'long'});
  const base = firstCellDate(y, m_idx);
  const filter = currentFilter();
  
  for(let i=0;i<42;i++){
    const d = new Date(base); d.setDate(base.getDate()+i);
    const iso = fmtISO(d); 
    const inMonth = d.getMonth()===m_idx;
    const {letter, number} = letterNumFor(iso);
    const trip = triplet(letter, number);
    const holiday = HK_HOLIDAYS_2025.get(iso) || '';
    const marker = customMarkers[iso];

    const cell = document.createElement('div');
    cell.className = 'cell' + (inMonth ? '' : ' dim');
    cell.dataset.iso = iso; cell.dataset.letter=letter;
    
    if (holiday) {
        cell.classList.add('is-holiday');
        cell.addEventListener('click', () => { showModal(holiday); });
    } else if (marker) {
        cell.classList.add('is-marker');
        cell.style.borderColor = `var(--marker-${marker.color})`;
        cell.addEventListener('click', () => { showModal(marker.description); });
    }
    
    if(filter.size > 0 && inMonth) {
      const tripLetters = trip.map(code => code[0]);
      const hasMatch = tripLetters.some(l => filter.has(l));
      if (!hasMatch) {
        cell.classList.add('filtered-dim');
      }
    }

    const head = document.createElement('div'); head.className='dhead';
    const num = document.createElement('div'); num.className='dnum' + (iso === TODAY_ISO ? ' today' : '');
    num.textContent = d.getDate();
    head.appendChild(num);
    head.appendChild(document.createElement('div'));
    cell.appendChild(head);

    if(inMonth){
      const tp=document.createElement('div'); tp.className='trip';
      trip.forEach(code=>{ const div=document.createElement('div'); div.className='code '+code[0]; div.textContent=code; tp.appendChild(div); });
      cell.appendChild(tp);
      
      const notes = document.createElement('input');
      notes.type = 'text';
      notes.className = 'notes-input';
      notes.placeholder = 'åŠ å‚™è¨»...';
      notes.value = dailyNotes[iso] || '';
      notes.addEventListener('input', (e) => {
        dailyNotes[iso] = e.target.value.trim();
        if (dailyNotes[iso] === '') delete dailyNotes[iso];
        saveData();
      });
      notes.addEventListener('click', (e) => { e.stopPropagation(); });
      cell.appendChild(notes);
    }
    targetGrid.appendChild(cell);
  }
}

// --- collectRows å‡½æ•¸ (ä¸è®Š) ---
function collectRows(isoDates){
  const rows = [];
  for(const iso of isoDates){
    const {letter, number} = letterNumFor(iso);
    const [t1,t2,t3] = triplet(letter, number);
    rows.push({
      iso,
      triplet:[t1,t2,t3],
      note: dailyNotes[iso] || ''
    });
  }
  return rows;
}

// --- exportCSV å‡½æ•¸ (ä¸è®Š) ---
function exportCSV(rows){
  const header = ['æ—¥æœŸ', 'é€±æœŸ', 'å‚™è¨»'];
  const lines = [header.join(',')];
  for(const r of rows){
    const cells = [ r.iso, r.triplet.join(' '), r.note || '' ]
      .map(v => String(v).replaceAll('"','""'));
    lines.push(cells.map(v => /[",\n]/.test(v) ? `"${v}"` : v).join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='calendar_notes_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}

// ---- ä¸»è¦åŸ·è¡Œï¼šç­‰ DOM Ready (å·²æ›´æ–°) ----
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  
  const mainWrap = document.getElementById('mainWrap');
  const monthPick = document.getElementById('monthPick');
  const prevM = document.getElementById('prevM');
  const nextM = document.getElementById('nextM');
  const chips = Array.from(document.querySelectorAll('.chip'));
  const btnExport = document.getElementById('btnExport');
  const modalCloseBtn = document.getElementById('customAlertClose');
  const modalBackdrop = document.getElementById('customAlert');
  
  const btnAddMarker = document.getElementById('btnAddMarker');
  const markerModal = document.getElementById('markerModal');
  const btnCancelMarker = document.getElementById('btnCancelMarker');
  const btnSaveMarker = document.getElementById('btnSaveMarker');
  
  // --- æ–°å¢ï¼šHelp & Text Export å…ƒç´  ---
  const btnHelp = document.getElementById('btnHelp');
  const helpModal = document.getElementById('helpModal');
  const btnCloseHelp = document.getElementById('btnCloseHelp');
  const btnExportText = document.getElementById('btnExportText');

  let currentGrid = document.getElementById('grid');
  let isAnimating = false;
  
  mainWrap.style.position = 'relative';
  mainWrap.style.overflowX = 'hidden';

  if (!currentGrid || !monthPick || !prevM || !nextM || !btnExport || !btnAddMarker || !btnHelp || !btnExportText) {
      console.error('Initialization failed: Missing critical DOM elements.');
      return;
  }

  const t = new Date(TODAY_ISO+'T00:00:00');
  const startYear = t.getFullYear();
  const startMonthIndex = t.getMonth();
  monthPick.value = `${startYear}-${(startMonthIndex + 1).toString().padStart(2, '0')}`;
  
  const todayDow = t.getDay();
  const weekbarDivs = document.querySelectorAll('#weekbar div');
  if (weekbarDivs[todayDow]) {
      weekbarDivs[todayDow].classList.add('is-today');
  }

  // --- åˆ‡æ›æœˆä»½æ ¸å¿ƒå‡½æ•¸ (å·²æ›´æ–°ï¼šä¿®æ­£å‹•ç•«) ---
  function changeMonth(direction) {
      if (isAnimating) return;
      isAnimating = true;

      const [y, m] = monthPick.value.split('-').map(Number);
      const d = new Date(y, m - 1, 1);
      d.setMonth(d.getMonth() + direction);
      
      const newY = d.getFullYear();
      const newM_idx = d.getMonth();
      
      monthPick.value = `${newY}-${(newM_idx + 1).toString().padStart(2, '0')}`;

      const newGrid = document.createElement('div');
      newGrid.className = 'grid'; newGrid.id = 'grid';

      render(newGrid, newY, newM_idx); 
      
      const oldGrid = currentGrid;
      oldGrid.id = 'grid-old';
      
      mainWrap.appendChild(newGrid);
      currentGrid = newGrid;
      
      // --- ä¿®æ”¹ï¼šä½¿ç”¨ animationend ç¢ºä¿å‹•ç•«é †æš¢ ---
      let animationEnded = false;
      const onAnimEnd = () => {
          if (animationEnded) return;
          animationEnded = true;
          if (document.body.contains(oldGrid)) {
            oldGrid.remove();
          }
          isAnimating = false;
      };
      
      oldGrid.addEventListener('animationend', onAnimEnd);
      setTimeout(onAnimEnd, 450); // Fallback

      requestAnimationFrame(() => {
          if (direction > 0) { // Next
              oldGrid.classList.add('animate-out-left');
              newGrid.classList.add('animate-in-right');
          } else { // Prev
              oldGrid.classList.add('animate-out-right');
              newGrid.classList.add('animate-in-left');
          }
      });
  }
  
  // --- ç¶å®šäº‹ä»¶ (å·²æ›´æ–°) ---
  prevM.addEventListener('click', () => changeMonth(-1));
  nextM.addEventListener('click', () => changeMonth(1));
  
  monthPick.addEventListener('change', () => {
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  chips.forEach(c=>c.addEventListener('click', ()=>{
    c.dataset.on = c.dataset.on==='1' ? '0' : '1';
    const [y, m] = monthPick.value.split('-').map(Number);
    render(currentGrid, y, m - 1);
  }));

  btnExport.addEventListener('click', ()=>{
    const isoDatesWithNotes = Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== '');
    if(isoDatesWithNotes.length === 0){ 
      showModal('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€é …å‚™è¨»ã€‚');
      return; 
    }
    const rows = collectRows(isoDatesWithNotes.sort());
    exportCSV(rows);
  });

  modalCloseBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  
  btnAddMarker.addEventListener('click', () => { showMarkerModal(); });
  btnCancelMarker.addEventListener('click', closeMarkerModal);
  markerModal.addEventListener('click', (e) => {
    if (e.target === markerModal) closeMarkerModal();
  });
  btnSaveMarker.addEventListener('click', () => {
      const date = document.getElementById('markerDate').value;
      const desc = document.getElementById('markerDesc').value;
      const color = document.querySelector('input[name="markerColor"]:checked').value;
      
      if (!date || !desc) {
          showModal('è«‹å¡«å¯«æ—¥æœŸå’Œèªªæ˜ã€‚');
          return;
      }
      
      customMarkers[date] = { description: desc, color: color };
      saveData();
      closeMarkerModal();
      
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });
  
  // --- æ–°å¢ï¼šHelp & Text Export äº‹ä»¶ ---
  btnHelp.addEventListener('click', showHelpModal);
  btnCloseHelp.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) closeHelpModal();
  });
  
  btnExportText.addEventListener('click', () => {
      const allIsoDates = new Set([
          ...Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== ''), 
          ...Object.keys(customMarkers)
      ]);
      
      const sortedDates = Array.from(allIsoDates).sort();
      
      if (sortedDates.length === 0) {
          showModal('æ²’æœ‰ä»»ä½•å‚™è¨»æˆ–æ¨™è¨˜å¯ä¾›è¤‡è£½ã€‚');
          return;
      }

      let output = "ğŸ“… ä½ çš„æ—¥æ›†åŒ¯å‡º\n--------------------\n\n";
      
      for (const iso of sortedDates) {
          const d = new Date(iso + 'T00:00:00');
          const weekday = d.toLocaleDateString('zh-HK', { weekday: 'short' });
          const note = dailyNotes[iso];
          const marker = customMarkers[iso];
          const holiday = HK_HOLIDAYS_2025.get(iso);

          output += `${iso} (${weekday})\n`;
          
          if (holiday) {
              output += `  - å‡æœŸ: ${holiday}\n`;
          }
          if (marker) {
              const colorName = marker.color === 'blue' ? 'è—è‰²' : 'ç¶ è‰²';
              output += `  - æ¨™è¨˜: ${marker.description} (${colorName})\n`;
          }
          if (note && note.trim() !== '') {
              output += `  - å‚™è¨»: ${note}\n`;
          }
          output += '\n'; // Add a blank line for spacing
      }
      
      output += "--------------------";
      copyToClipboard(output);
  });


  // --- åˆå§‹ Render ---
  render(currentGrid, startYear, startMonthIndex);
});
</script>
</body>
</html>



