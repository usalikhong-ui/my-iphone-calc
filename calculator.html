<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ABCDE æœˆæ›†ï¼ˆå‚™è¨»ç‰ˆï¼‰</title>
<!-- 
  v5.3 - 2025-11-09
  1.  (FIX) ä¿®æ­£ 12hr ç¯©é¸é‚è¼¯ï¼Œä½¿å…¶æª¢æŸ¥ tripFive[0], [1], [2] æ‰€æœ‰ä¸‰å€‹ç­æ¬¡ã€‚
  2.  (FIX) ä¿®æ­£ v5.1 ä¸­ 'e.g.target.value' å˜…æ‰“å­—éŒ¯èª¤ã€‚
-->
<style>
  :root{
    --bg: #0b1220;
    --panel: rgba(255,255,255,.08);
    --card: rgba(255,255,255,.12);
    --stroke: rgba(255,255,255,.18);
    --txt: #f6f7fb;
    --muted: #c5cbd6;
    --accent: #7dd3fc;
    --today: #ffd166;
    --weekbar: #364156;
    --holiday: #e11d48;
    --marker-blue: #3b82f6;
    --marker-green: #22c55e;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang HK",
        "Noto Sans HK","Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;
        background: linear-gradient(180deg, #0a0f19, #0b1220 30%, #0b1220 100%); color:var(--txt); }
  header{ position:sticky; top:0; z-index:5; background: rgba(11,18,32,.75);
          backdrop-filter: blur(10px); border-bottom:1px solid var(--stroke); }
  
  .wrap{ max-width:1100px; margin:0 auto; padding:8px; }
  
  .top-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
  }
  .top-filters {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  
  .button-group {
    display: flex;
    gap: 10px;
    margin-left: auto; /* å°‡æ‰€æœ‰æŒ‰éˆ•æ¨åˆ°æœ€å³ */
    flex-shrink: 0;
    flex-wrap: wrap; /* æ›è¡Œ */
    justify-content: flex-end;
  }
  .btn-add-marker {
    padding: 6px 10px;
    font-size: 13px;
    background: var(--accent);
    color: var(--bg);
    border: none;
  }
  .btn-help {
    background: var(--today);
    color: var(--bg);
    font-weight: 600;
    border: none;
  }
  
  .title {
    flex-grow: 1;
    text-align: center;
  }
  
  .navbtn{ 
    background: var(--panel); border:1px solid var(--stroke); padding:8px;
    border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink: 0;
  }
  .title{ font-weight:700; letter-spacing:.5px; padding:6px 10px; border-radius:10px; background:var(--panel); border:1px solid var(--stroke); }
  input[type="month"]{ background:transparent; color:var(--txt); border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px; outline:none; flex-shrink: 0; }
  .chip{ padding:6px 12px; border-radius:999px; background: var(--panel); border:1px solid var(--stroke); cursor:pointer; user-select:none; }
  
  .btn.chip { user-select: none; }

  /* 12hr/24hr æŒ‰éˆ•ç‰¹å®šé¡è‰² */
  #btnToggle12hr,
  #btnToggle24hr {
    transition: background-color 0.2s, color 0.2s, border-color 0.2s, opacity 0.2s;
    font-weight: 600;
    color: #ffffff; /* æ–‡å­—çµ±ä¸€ç™½è‰² */
    outline: none; /* ç§»é™¤é»æ“Šæ™‚å˜… blue outline */
    border: 1px solid var(--stroke);
  }

  #btnToggle12hr[data-on="1"],
  #btnToggle24hr[data-on="1"] {
    /* ON State (Green) */
    background-color: #22c55e;
    border-color: #22c55e;
    opacity: 1;
  }
  
  #btnToggle12hr[data-on="0"],
  #btnToggle24hr[data-on="0"] {
    /* OFF State (Red) */
    background-color: #e11d48;
    border-color: #e11d48;
    opacity: 0.85; /* ç¨ç‚ºèª¿æš— */
  }
  
  #btnToggle12hr:hover,
  #btnToggle24hr:hover {
    opacity: 1; /* ç¢ºä¿ hover æ™‚ 100% */
    outline: none; 
  }
  
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--panel); color:var(--txt); cursor:pointer; }
  .btn:hover:not(#btnToggle12hr):not(#btnToggle24hr) { 
    outline:2px solid var(--accent); 
  }
  
  .weekbar{ display:grid; grid-template-columns: repeat(7,1fr); background: var(--weekbar); border-radius:10px; overflow:hidden; margin-top:10px; }
  .weekbar div{ text-align:center; padding:8px 0; font-size:12px; color:#e7eaf1; transition: color 0.2s; }
  .weekbar div.is-today {
    color: var(--today);
    font-weight: 700;
  }
  
  .grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:3px; margin-top:8px; }
  
  .cell{ 
    min-height: 110px; 
    background: var(--card); border:1px solid var(--stroke); border-radius:10px; 
    padding: 5px;
    display:flex; flex-direction:column; 
    gap: 3px;
    transition: opacity .2s, border-color .2s; cursor:pointer; 
  }
  .cell.dim{ opacity:.35; }
  
  .cell.filtered-dim { opacity: .35; }
  
  .dhead{ display:flex; align-items:center; justify-content:space-between; }
  .dnum{ font-weight:700; font-size: 15px; }
  .dnum.today{ outline:2px solid var(--today); border-radius:8px; padding:1px 5px; }

  .cell.is-holiday {
    border-left: 3px solid var(--holiday);
    padding-left: 6px;
  }
  .cell.is-marker {
    border-left-width: 3px;
    padding-left: 6px;
  }

  .trip-five, .trip-three {
    display: none;
    flex-direction: column;
    gap: 1px;
  }
  .grid.show-five-team .trip-five {
    display: flex;
  }
  .grid.show-three-team .trip-three {
    display: flex;
    border-top: 1px dashed var(--stroke);
    margin-top: 4px;
    padding-top: 4px;
  }
  
  .code{ font-weight:800; letter-spacing:0.1px; font-size: 12px; }
  
  .A{ color:#3b82f6;} 
  .B{ color:#f59e0b;} 
  .C{ color:#22c55e;} 
  .D{ color:#8b5cf6;} 
  .E{ color:#fb7185;}
  
  .notes-input{
    margin-top:auto;
    width:100%;
    background: var(--panel);
    border:1px solid var(--stroke);
    border-radius:6px;
    color: var(--txt);
    padding:4px 6px;
    font-size:11px;
    outline: none;
    cursor:text;
  }
  .notes-input::placeholder{ color: var(--muted); opacity: 0.6; }
  .notes-input:focus{ outline:1px solid var(--accent); }

  .modal-backdrop {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity .2s;
  }
  .modal-backdrop.show {
    opacity: 1; pointer-events: auto;
  }
  .modal-content {
    background: #1c2536;
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
    max-width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .modal-content p {
    text-align: center;
    margin-top: 0;
  }
  .modal-content button {
    margin-top: 15px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .modal-content h3 {
    margin-top: 0;
    text-align: left;
  }
  .modal-content ul {
    text-align: left;
    padding-left: 20px;
    color: var(--muted);
  }
  .modal-content li {
    margin-bottom: 10px;
    line-height: 1.5;
  }
  .modal-content code {
    background: var(--panel);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 15px;
    text-align: left;
  }
  .form-group label {
    font-size: 13px;
    color: var(--muted);
  }
  .form-group input, .form-group select {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    padding: 8px 10px;
    color: var(--txt);
    outline: none;
  }
  .form-group input:focus, .form-group select:focus {
    outline: 1px solid var(--accent);
  }
  
  .radio-group-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  .radio-group-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }
  .radio-group-row label, .radio-group-grid label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .filter-options-group {
    border-top: 1px solid var(--stroke);
    margin-top: 15px;
    padding-top: 15px;
  }
  
  .color-select {
    display: flex;
    gap: 10px;
  }
  .color-select label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .color-dot {
    width: 16px; height: 16px;
    border-radius: 50%;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .modal-actions button.secondary {
    background: var(--panel);
    color: var(--txt);
  }
  
  /* å‹•ç•« */
  @keyframes bounce-in-right {
      0% { transform: translateX(100%); opacity: 0; }
      60% { transform: translateX(-10%); opacity: 1; }
      80% { transform: translateX(5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-left {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
  }
  @keyframes bounce-in-left {
      0% { transform: translateX(-100%); opacity: 0; }
      60% { transform: translateX(10%); opacity: 1; }
      80% { transform: translateX(-5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-right {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
  }

  .grid.animate-in-right { animation: bounce-in-right 0.4s ease-out forwards; }
  .grid.animate-out-left { animation: bounce-out-left 0.4s ease-out forwards; }
  .grid.animate-in-left { animation: bounce-in-left 0.4s ease-out forwards; }
  .grid.animate-out-right { animation: bounce-out-right 0.4s ease-out forwards; }
  
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top-controls">
      <button class="navbtn" id="prevM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <div class="title" id="title"></div>
      <button class="navbtn" id="nextM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
      <input type="month" id="monthPick">
    </div>
    <div class="top-filters">
      
      <div class="button-group">
        <button class="btn chip" id="btnToggle12hr" data-on="1">12å°æ™‚å·¥ä½œ</button>
        <button class="btn chip" id="btnToggle24hr" data-on="0">24å°æ™‚å·¥ä½œ</button>
        <button class="btn" id="btnShowFilter" style="background: var(--panel);">ç¯©é¸</button>
        <button class="btn btn-help" id="btnHelp">èªªæ˜</button>
        <button class="btn btn-add-marker" id="btnAddMarker">+ æ¨™è¨˜</button>
        <button class="btn" id="btnExportText">è¼¸å‡ºæ–‡å­—</button>
        <button class="btn" id="btnExport">è¼¸å‡º CSV</button>
      </div>
    </div>
    <div class="weekbar" id="weekbar">
      <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
  </div>
</header>

<main class="wrap" id="mainWrap">
  <div class="grid" id="grid"></div>
</main>

<!-- å½ˆçª— (æç¤º) -->
<div class="modal-backdrop" id="customAlert">
  <div class="modal-content">
    <p id="customAlertMsg"></p>
    <button id="customAlertClose">æ˜ç™½</button>
  </div>
</div>

<!-- å½ˆçª— (æ–°å¢æ¨™è¨˜) -->
<div class="modal-backdrop" id="markerModal">
  <div class="modal-content">
    <h3>æ–°å¢è‡ªè¨‚æ¨™è¨˜</h3>
    <div class="form-group">
      <label for="markerDate">æ—¥æœŸ</label>
      <input type="date" id="markerDate">
    </div>
    <div class="form-group">
      <label for="markerDesc">èªªæ˜</label>
      <input type="text" id="markerDesc" placeholder="e.g. è¦†è¨º">
    </div>
    <div class="form-group">
      <label>é¡è‰²</label>
      <div class="color-select">
        <label>
          <input type="radio" name="markerColor" value="blue" checked>
          <span class="color-dot" style="background: var(--marker-blue);"></span> è—è‰²
        </label>
        <label>
          <input type="radio" name="markerColor" value="green">
          <span class="color-dot" style="background: var(--marker-green);"></span> ç¶ è‰²
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="secondary" id="btnCancelMarker">å–æ¶ˆ</button>
      <button id="btnSaveMarker">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- --- å½ˆçª— (é¡¯ç¤º/åˆªé™¤æ¨™è¨˜) --- -->
<div class="modal-backdrop" id="markerInfoModal">
  <div class="modal-content">
    <h3 style="display: flex; align-items: center; gap: 8px;">
      <span id="markerInfoColor" class="color-dot"></span>
      æ¨™è¨˜è©³æƒ…
    </h3>
    <p id="markerInfoDate" style="font-size: 14px; color: var(--muted); text-align: left; margin: 0;"></p>
    <p id="markerInfoDesc" style="font-size: 16px; text-align: left; margin: 10px 0 20px;"></p>
    <div class="modal-actions">
      <button class="secondary" id="btnCloseMarkerInfo">é—œé–‰</button>
      <button id="btnDeleteMarker" style="background: var(--holiday); color: var(--txt);">åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- --- æ–°å¢ï¼šç¯©é¸ Modal --- -->
<div class="modal-backdrop" id="filterModal">
  <div class="modal-content">
    <h3>é€±æœŸç¯©é¸</h3>
    
    <div class="form-group">
      <label>ç¯©é¸é¡å‹</label>
      <div class="radio-group-row">
        <label><input type="radio" name="filterType" value="none" checked> ä¸ç¯©é¸</label>
        <label><input type="radio" name="filterType" value="12hr"> 12å°æ™‚</label>
        <label><input type="radio" name="filterType" value="24hr"> 24å°æ™‚</label>
      </div>
    </div>

    <!-- 12-hour options -->
    <div class="filter-options-group" id="filterOptions12hr" style="display: none;">
      <div class="form-group">
        <label>12å°æ™‚ - å­—æ¯</label>
        <div class="radio-group-grid">
          <label><input type="radio" name="filter12Letter" value="none" checked> ç„¡</label>
          <label><input type="radio" name="filter12Letter" value="A"> A</label>
          <label><input type="radio" name="filter12Letter" value="B"> B</label>
          <label><input type="radio" name="filter12Letter" value="C"> C</label>
          <label><input type="radio" name="filter12Letter" value="D"> D</label>
          <label><input type="radio" name="filter12Letter" value="E"> E</label>
        </div>
      </div>
      <div class="form-group">
        <label>12å°æ™‚ - æ•¸å­— (Rota)</label>
        <div class="radio-group-grid" style="grid-template-columns: repeat(6, 1fr);">
          <label><input type="radio" name="filter12Number" value="none" checked> ç„¡</label>
          <label><input type="radio" name="filter12Number" value="1"> 1</label>
          <label><input type="radio" name="filter12Number" value="2"> 2</label>
          <label><input type="radio" name="filter12Number" value="3"> 3</label>
          <label><input type="radio" name="filter12Number" value="4"> 4</label>
          <label><input type="radio" name="filter12Number" value="5"> 5</label>
          <label><input type="radio" name="filter12Number" value="6"> 6</label>
          <label><input type="radio" name="filter12Number" value="7"> 7</label>
          <label><input type="radio" name="filter12Number" value="8"> 8</label>
          <label><input type="radio" name="filter12Number" value="9"> 9</label>
          <label><input type="radio" name="filter12Number" value="10"> 10</label>
        </div>
      </div>
    </div>

    <!-- 24-hour options -->
    <div class="filter-options-group" id="filterOptions24hr" style="display: none;">
      <div class="form-group">
        <label>24å°æ™‚ - å­—æ¯</label>
        <div class="radio-group-grid">
          <label><input type="radio" name="filter24Letter" value="none" checked> ç„¡</label>
          <label><input type="radio" name="filter24Letter" value="A"> A</label>
          <label><input type="radio" name="filter24Letter" value="B"> B</label>
          <label><input type="radio" name="filter24Letter" value="C"> C</label>
          <label><input type="radio" name="filter24Letter" value="D"> D</label>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="secondary" id="btnClearFilter">æ¸…é™¤ç¯©é¸</button>
      <button class="secondary" id="btnCancelFilter">å–æ¶ˆ</button>
      <button id="btnApplyFilter">å¥—ç”¨ç¯©é¸</button>
    </div>
  </div>
</div>


<!-- å½ˆçª— (å¹«åŠ©èªªæ˜) -->
<div class="modal-backdrop" id="helpModal">
  <div class="modal-content">
    <h3>ä½¿ç”¨èªªæ˜</h3>
    <!-- --- èªªæ˜æ–‡å­— (å·²æ›´æ–°) --- -->
    <ul>
      <li><b>é€±æœŸç¯©é¸</b>: é»æ“Š <code>ç¯©é¸</code> æŒ‰éˆ•ï¼Œå¯ä»¥å½ˆå‡ºç¯©é¸è¦–çª—ã€‚æ‚¨å¯ä»¥åš´æ ¼å€åˆ†ã€Œ12å°æ™‚ã€æˆ–ã€Œ24å°æ™‚ã€å·¥ä½œé¡å‹é€²è¡Œç¯©é¸ã€‚</li>
      <li><b>12å°æ™‚ / 24å°æ™‚</b>: é»æ“Š <code>12å°æ™‚å·¥ä½œ</code> æˆ– <code>24å°æ™‚å·¥ä½œ</code> æŒ‰éˆ•ï¼Œå¯åˆ‡æ›é¡¯ç¤ºå°æ‡‰å˜…ç­æ¬¡æ’åºã€‚</li>
      <li><b>è‡ªå‹•å„²å­˜</b>: åœ¨æ—¥æœŸæ ¼åº•éƒ¨è¼¸å…¥çš„ã€Œå‚™è¨»ã€ï¼Œå°‡æœƒè‡ªå‹•å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸‹æ¬¡é–‹å•Ÿæ™‚è³‡æ–™å°‡è‡ªå‹•è¼‰å…¥ã€‚</li>
      <li><b>å…¬çœ¾å‡æœŸ</b>: å·¦å´å¸¶æœ‰<code>ç´…è‰²</code>é‚Šæ¡†çš„æ—¥æœŸç‚ºé¦™æ¸¯å…¬çœ¾å‡æœŸï¼Œé»æ“Šè©²æ—¥æœŸæ ¼å¯æŸ¥çœ‹å‡æœŸåç¨±ã€‚</li>
      <li><b>è‡ªè¨‚æ¨™è¨˜</b>: é»æ“Š <code>+ æ¨™è¨˜</code> æŒ‰éˆ•å¯æ–°å¢æ¨™è¨˜ã€‚é»æ“Šå·²æ¨™è¨˜å˜…æ—¥æœŸæ ¼ï¼Œå¯ä»¥æŸ¥é–±èªªæ˜æˆ– <code>åˆªé™¤</code> è©²æ¨™è¨˜ã€‚</li>
      <li><b>è¼¸å‡ºæ–‡å­— / CSV</b>: é»æ“Šè¼¸å‡ºæŒ‰éˆ•ï¼Œç³»çµ±å°‡å°å‡º *æ‰€æœ‰* ç­æ¬¡è³‡æ–™ (åŒ…æ‹¬ 12/24 å°æ™‚) åŠå‚™è¨»ï¼Œç„¡è«–ç•¶å‰æ˜¯å¦éš±è—ã€‚</li>
    </ul>
    <button id="btnCloseHelp">æ˜ç™½</button>
  </div>
</div>


<script>
// ---- å›ºå®šè¦å‰‡ï¼šä»Šæ—¥ 2025-11-09 = C6 ----
const LETTERS = ['A','B','C','D','E'];
const TODAY_ISO = '2025-11-09';
const ANCHOR_LETTER = 'C';
const ANCHOR_NUMBER = 6;

// --- "24å°æ™‚å·¥ä½œ" (ä¸‰éšŠåˆ¶) æ’åºé‚è¼¯ ---
const ANCHOR_3_TEAM = '2025-11-09';
const CYCLE_24 = ['C(24)', 'A(24)', 'B(24)']; // 3-day cycle
const CYCLE_4D = ['C(2D)', 'D(2D)', 'A(2D)', 'B(2D)']; // 4-day cycle

// --- å…§ç½®å‡æœŸè³‡æ–™åº« (2024-2026) ---
const HOLIDAY_DATA = {
    "2024": {
        "2024-01-01": "å…ƒæ—¦", "2024-02-10": "è¾²æ›†å¹´åˆä¸€", "2024-02-12": "è¾²æ›†å¹´åˆä¸‰", "2024-02-13": "è¾²æ›†å¹´åˆå››", "2024-03-29": "è€¶ç©Œå—é›£ç¯€", "2024-03-30": "è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥", "2024-04-01": "å¾©æ´»ç¯€æ˜ŸæœŸä¸€", "2024-04-04": "æ¸…æ˜ç¯€", "2024-05-01": "å‹å‹•ç¯€", "2024-05-15": "ä½›èª•", "2024-06-10": "ç«¯åˆç¯€", "2024-07-01": "é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥", "2024-09-18": "ä¸­ç§‹ç¯€ç¿Œæ—¥", "2024-10-01": "åœ‹æ…¶æ—¥", "2024-10-11": "é‡é™½ç¯€", "2024-12-25": "è–èª•ç¯€", "2024-12-26": "è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥"
    },
    "2025": {
        "2025-01-01": "å…ƒæ—¦", "2025-01-29": "è¾²æ›†å¹´åˆä¸€", "2025-01-30": "è¾²æ›†å¹´åˆäºŒ", "2025-01-31": "è¾²æ›†å¹´åˆä¸‰", "2025-04-18": "è€¶ç©Œå—é›£ç¯€", "2025-04-19": "è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥", "2025-04-21": "å¾©æ´»ç¯€æ˜ŸæœŸä¸€", "2025-04-04": "æ¸…æ˜ç¯€", "2025-05-01": "å‹å‹•ç¯€", "2025-05-05": "ä½›èª•", "2025-05-31": "ç«¯åˆç¯€", "2025-07-01": "é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥", "2025-10-01": "åœ‹æ…¶æ—¥", "2025-10-07": "ä¸­ç§‹ç¯€ç¿Œæ—¥", "2025-10-30": "é‡é™½ç¯€", "2025-12-25": "è–èª•ç¯€", "2025-12-26": "è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥"
    },
    "2026": {
        "2026-01-01": "å…ƒæ—¦", "2026-02-17": "è¾²æ›†å¹´åˆä¸€", "2026-02-18": "è¾²æ›†å¹´åˆäºŒ", "2026-02-19": "è¾²æ›†å¹´åˆä¸‰", "2026-04-03": "è€¶ç©Œå—é›£ç¯€", "2026-04-04": "è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥", "2026-04-06": "å¾©æ´»ç¯€æ˜ŸæœŸä¸€", "2026-04-04": "æ¸…æ˜ç¯€", "2026-05-01": "å‹å‹•ç¯€", "2026-05-25": "ä½›èª•", "2026-06-19": "ç«¯åˆç¯€", "2026-07-01": "é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥", "2026-09-26": "ä¸­ç§‹ç¯€ç¿Œæ—¥", "2026-10-01": "åœ‹æ…¶æ—¥", "2026-10-02": "åœ‹æ…¶æ—¥ç¿Œæ—¥", "2026-10-19": "é‡é™½ç¯€", "2026-12-25": "è–èª•ç¯€"
    }
};

// ---- Global æ•¸æ“šå„²å­˜ ----
let dailyNotes = {}; 
let customMarkers = {};
let holidaysCache = new Map(); 

// --- Global é¡¯ç¤ºç‹€æ…‹ (å·²æ›´æ–°é è¨­å€¼) ---
let showFiveTeam = true;  // 12å°æ™‚å·¥ä½œ (é è¨­ ON)
let showThreeTeam = false; // 24å°æ™‚å·¥ä½œ (é è¨­ OFF)
let currentMarkerISO = null; // ç”¨æ–¼è¿½è¹¤è¦åˆªé™¤å˜…æ¨™è¨˜

// --- æ–°å¢ï¼šGlobal ç¯©é¸ç‹€æ…‹ ---
let filterState = {
    type: 'none', // 'none', '12hr', '24hr'
    letter12: 'none',
    number12: 'none',
    letter24: 'none'
};

// ---- å„²å­˜/è®€å–åŠŸèƒ½ (LocalStorage) ----
function saveData() {
    try {
        localStorage.setItem('calendarNotes', JSON.stringify(dailyNotes));
        localStorage.setItem('calendarMarkers', JSON.stringify(customMarkers));
    } catch (e) {
        console.error('Failed to save data', e);
        showModal('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç©ºé–“å¯èƒ½å·²æ»¿ã€‚');
    }
}
function loadData() {
    const notes = localStorage.getItem('calendarNotes');
    const markers = localStorage.getItem('calendarMarkers');
    try {
      if (notes) { dailyNotes = JSON.parse(notes) || {}; }
      if (markers) { customMarkers = JSON.parse(markers) || {}; }
    } catch (e) {
      console.error('Failed to parse saved data', e);
      dailyNotes = {}; customMarkers = {};
    }
}

// ---- å·¥å…·å‡½æ•¸ ----
function fmtISO(d){
  const y = d.getFullYear();
  const m = (d.getMonth() + 1).toString().padStart(2, '0');
  const day = d.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function daysBetween(aISO,bISO){ return Math.round((new Date(bISO)-new Date(aISO))/86400000); }
function mod(a,b){ return ((a % b)+b)%b; }

// --- è¨ˆç®—ä¸»æ›´ "12å°æ™‚" (e.g. C6) ---
function letterNumFor(dateISO){
  const i0 = LETTERS.indexOf(ANCHOR_LETTER);
  const n = daysBetween(TODAY_ISO, dateISO);
  const idx = mod(i0 - n, 5);
  const wraps = Math.floor((i0 + n)/5);
  let num = ANCHOR_NUMBER + wraps;
  num = ((num - 1) % 10 + 10) % 10 + 1;
  return {letter: LETTERS[idx], number: num};
}

// --- "12å°æ™‚" æ’åºé‚è¼¯ [Anchor(date), Anchor(date-1), Anchor(date-2)] ---
function triplet(dateISO){
  const d = new Date(dateISO + 'T00:00:00');
  
  const {letter, number} = letterNumFor(dateISO);
  const t1 = `${letter}${number}`;
  
  d.setDate(d.getDate() - 1);
  const iso_d1 = fmtISO(d);
  const {letter: l_d1, number: n_d1} = letterNumFor(iso_d1);
  const t2 = `${l_d1}${n_d1}`;
  
  d.setDate(d.getDate() - 1);
  const iso_d2 = fmtISO(d);
  const {letter: l_d2, number: n_d2} = letterNumFor(iso_d2);
  const t3 = `${l_d2}${n_d2}`;
  
  return [t1, t2, t3];
}

// --- "24å°æ™‚" (ä¸‰éšŠåˆ¶) æ’åºé‚è¼¯ (å·²æ›´æ–°) ---
function tripletThreeTeam(dateISO) {
  const n = daysBetween(ANCHOR_3_TEAM, dateISO);
  
  const shift1 = CYCLE_24[mod(n, 3)];
  const shift2 = CYCLE_4D[mod(n, 4)];
  const shift3 = CYCLE_4D[mod(n - 1, 4)];
  
  return [shift1, shift2, shift3];
}


// è¨ˆç®—æœˆæ›†ç¬¬ä¸€æ ¼ (å¯èƒ½ä¿‚ä¸Šå€‹æœˆ) å˜…æ—¥æœŸ
function firstCellDate(y, m){
  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  return new Date(y, m, 1 - startDow);
}

// ---- Modal é¡¯ç¤º/éš±è— ----
function showModal(message) {
  const modal = document.getElementById('customAlert');
  const msg = document.getElementById('customAlertMsg');
  msg.textContent = message;
  modal.classList.add('show');
}
function closeModal() {
  const modal = document.getElementById('customAlert');
  modal.classList.remove('show');
}
function showMarkerModal(dateISO = '') {
    document.getElementById('markerDate').value = dateISO || fmtISO(new Date());
    document.getElementById('markerDesc').value = '';
    document.querySelector('input[name="markerColor"][value="blue"]').checked = true;
    document.getElementById('markerModal').classList.add('show');
}
function closeMarkerModal() {
    document.getElementById('markerModal').classList.remove('show');
}
function showHelpModal() {
    document.getElementById('helpModal').classList.add('show');
}
function closeHelpModal() {
    document.getElementById('helpModal').classList.remove('show');
}

// --- æ–°å¢ï¼šç¯©é¸ Modal é¡¯ç¤º/éš±è— ---
function showFilterModal() {
    // è¼‰å…¥ modal æ™‚ï¼Œå°‡ global state å¡«å…¥ radio buttons
    document.querySelector(`input[name="filterType"][value="${filterState.type}"]`).checked = true;
    document.querySelector(`input[name="filter12Letter"][value="${filterState.letter12}"]`).checked = true;
    document.querySelector(`input[name="filter12Number"][value="${filterState.number12}"]`).checked = true;
    document.querySelector(`input[name="filter24Letter"][value="${filterState.letter24}"]`).checked = true;
    
    // æ ¹æ“š filterType é¡¯ç¤º/éš±è—é¸é …
    document.getElementById('filterOptions12hr').style.display = (filterState.type === '12hr') ? 'block' : 'none';
    document.getElementById('filterOptions24hr').style.display = (filterState.type === '24hr') ? 'block' : 'none';
    
    document.getElementById('filterModal').classList.add('show');
}
function closeFilterModal() {
    document.getElementById('filterModal').classList.remove('show');
}


// --- é¡¯ç¤º/åˆªé™¤ æ¨™è¨˜ Modal ---
function showMarkerInfoModal(iso, marker) {
    currentMarkerISO = iso; // å„²å­˜ iso ä¿¾åˆªé™¤æ£ç”¨
    const modal = document.getElementById('markerInfoModal');
    document.getElementById('markerInfoDesc').textContent = marker.description;
    document.getElementById('markerInfoColor').style.background = `var(--marker-${marker.color})`;
    document.getElementById('markerInfoDate').textContent = iso;
    modal.classList.add('show');
}
function closeMarkerInfoModal() {
    currentMarkerISO = null;
    document.getElementById('markerInfoModal').classList.remove('show');
}


// --- è¤‡è£½æ–‡å­—åˆ°å‰ªè²¼ç°¿ ---
function copyToClipboard(text) {
    const ta = document.createElement('textarea');
    ta.style.position = 'absolute';
    ta.style.left = '-9999px';
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try {
        document.execCommand('copy');
        showModal('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    } catch (err) {
        console.error('Failed to copy text: ', err);
        showModal('è¤‡è£½å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
    document.body.removeChild(ta);
}

// --- ç²å–è©²å¹´ä»½å˜…å‡æœŸ (ä½¿ç”¨å…§ç½®è³‡æ–™) ---
function getHolidayMapForYear(year) {
    const yearStr = String(year);
    if (holidaysCache.has(yearStr)) {
        return holidaysCache.get(yearStr);
    }
    if (HOLIDAY_DATA[yearStr]) {
        const holidayMap = new Map(Object.entries(HOLIDAY_DATA[yearStr]));
        holidaysCache.set(yearStr, holidayMap);
        return holidayMap;
    } else {
        return new Map();
    }
}


// ---- æ ¸å¿ƒ Render å‡½æ•¸ (ç¹ªè£½æœˆæ›†) ----
function render(targetGrid, y, m_idx){
  const title = document.getElementById('title');
  targetGrid.innerHTML = '';
  if (isNaN(y) || isNaN(m_idx)) { return; }
  
  targetGrid.dataset.year = y;
  targetGrid.dataset.monthIndex = m_idx;
  
  title.textContent = new Date(y, m_idx, 1).toLocaleString('zh-HK',{year:'numeric', month:'long'});
  
  targetGrid.classList.toggle('show-five-team', showFiveTeam);
  targetGrid.classList.toggle('show-three-team', showThreeTeam);
  
  const yearHolidayMap = getHolidayMapForYear(y);
  const base = firstCellDate(y, m_idx);
  
  for(let i=0;i<42;i++){
    const d = new Date(base); d.setDate(base.getDate()+i);
    const iso = fmtISO(d); 
    const inMonth = d.getMonth()===m_idx;
    
    // --- è¨ˆç®—å…©ç¨®æ’åº ---
    // const {letter, number} = letterNumFor(iso); // (v5.3 ä¿®æ­£ï¼šå‘¢è¡Œå””å†éœ€è¦)
    const tripFive = triplet(iso); // [C7, B7, A7]
    const tripThree = tripletThreeTeam(iso); // [C(24), C(2D), B(2D)]
    
    const holiday = yearHolidayMap.get(iso) || ''; 
    const marker = customMarkers[iso];

    const cell = document.createElement('div');
    cell.className = 'cell' + (inMonth ? '' : ' dim');
    cell.dataset.iso = iso; 
    // cell.dataset.letter=letter; // (v5.3 ä¿®æ­£ï¼šå‘¢è¡Œå””å†éœ€è¦)
    
    if (holiday) {
        cell.classList.add('is-holiday');
        cell.addEventListener('click', () => { showModal(holiday); });
    } else if (marker) {
        cell.classList.add('is-marker');
        cell.style.borderColor = `var(--marker-${marker.color})`;
        cell.addEventListener('click', () => { showMarkerInfoModal(iso, marker); });
    }
    
    // --- ç¯©é¸é‚è¼¯ (v5.3 ä¿®æ­£) ---
    let isFiltered = false;
    if (inMonth && filterState.type !== 'none') {
        
        if (filterState.type === '12hr') {
            // "12å°æ™‚" ç¯©é¸é‚è¼¯
            
            // æª¢æŸ¥ C / C7 / 7
            let letterMatch = (filterState.letter12 === 'none');
            let numberMatch = (filterState.number12 === 'none');
            
            // (FIX) æª¢æŸ¥æ‰€æœ‰ä¸‰å€‹ç­æ¬¡
            for (const shift of tripFive) { // e.g., tripFive = [C7, B7, A7]
                const letter = shift[0]; // C
                const numStr = (shift.match(/\d+/) || [''])[0]; // 7
                
                if (filterState.letter12 !== 'none' && filterState.letter12 === letter) {
                    letterMatch = true;
                }
                if (filterState.number12 !== 'none' && filterState.number12 === numStr) {
                    numberMatch = true;
                }
            }

            // é‡æ¸…é‚è¼¯ï¼š
            // 1. æ€ C, æ€ 7 -> æµ C or 7 (ç›®å‰é‚è¼¯)
            // 2. æ€ C, æ€ 7 -> æµ C AND 7 (å³ C7) (v5.3 æ–°é‚è¼¯)
            
            // v5.3 æ¡ç”¨é‚è¼¯ #2:
            // å¦‚æœ å­—æ¯ = 'none' and æ•¸å­— = 'none' -> å””ç¯©é¸ (match = true)
            // å¦‚æœ å­—æ¯ != 'none' and æ•¸å­— = 'none' -> æ·¨ä¿‚ check å­—æ¯
            // å¦‚æœ å­—æ¯ = 'none' and æ•¸å­— != 'none' -> æ·¨ä¿‚ check æ•¸å­—
            // å¦‚æœ å­—æ¯ != 'none' and æ•¸å­— != 'none' -> å¿…é ˆåŒæ™‚ match C åŒ 7

            let dayMatches = false;
            
            if (filterState.letter12 === 'none' && filterState.number12 === 'none') {
                dayMatches = true; // å””æ‡‰è©²ç™¼ç”Ÿï¼Œå› ç‚º type å””ä¿‚ 'none'
            } else if (filterState.letter12 !== 'none' && filterState.number12 === 'none') {
                // åªç¯©é¸å­—æ¯ (e.g., C)
                dayMatches = tripFive.some(shift => shift[0] === filterState.letter12);
            } else if (filterState.letter12 === 'none' && filterState.number12 !== 'none') {
                // åªç¯©é¸æ•¸å­— (e.g., 7)
                dayMatches = tripFive.some(shift => {
                    const numStr = (shift.match(/\d+/) || [''])[0];
                    return numStr === filterState.number12;
                });
            } else {
                // ç¯©é¸ å­—æ¯ AND æ•¸å­— (e.g., C7)
                dayMatches = tripFive.some(shift => {
                    const letter = shift[0];
                    const numStr = (shift.match(/\d+/) || [''])[0];
                    return letter === filterState.letter12 && numStr === filterState.number12;
                });
            }

            if (!dayMatches) {
                isFiltered = true;
            }
            
        } else if (filterState.type === '24hr') {
            // "24å°æ™‚" ç¯©é¸é‚è¼¯
            if (filterState.letter24 !== 'none') {
                const allLetters24 = tripThree.map(code => code[0]); // [C, C, B]
                const hasMatch = allLetters24.some(l => l === filterState.letter24);
                if (!hasMatch) {
                    isFiltered = true;
                }
            }
        }
    }
    
    if (isFiltered) {
        cell.classList.add('filtered-dim');
    }
    // --- (ç¯©é¸é‚è¼¯çµæŸ) ---

    const head = document.createElement('div'); head.className='dhead';
    const num = document.createElement('div'); num.className='dnum' + (iso === TODAY_ISO ? ' today' : '');
    num.textContent = d.getDate();
    head.appendChild(num);
    head.appendChild(document.createElement('div'));
    cell.appendChild(head);

    if(inMonth){
      const tp5 = document.createElement('div'); 
      tp5.className = 'trip-five';
      tripFive.forEach(code=>{ 
        const div=document.createElement('div'); 
        div.className='code';
        const letterForColor = code[0];
        div.classList.add(letterForColor);
        div.textContent=code; 
        tp5.appendChild(div); 
      });
      cell.appendChild(tp5);
      
      const tp3 = document.createElement('div'); 
      tp3.className = 'trip-three';
      tripThree.forEach(code=>{ 
        const div=document.createElement('div'); 
        div.className='code';
        const letterForColor = code[0];
        div.classList.add(letterForColor);
        div.textContent=code; 
        tp3.appendChild(div); 
      });
      cell.appendChild(tp3);
      
      const notes = document.createElement('input');
      notes.type = 'text';
      notes.className = 'notes-input';
      notes.placeholder = 'åŠ å‚™è¨»...';
      notes.value = dailyNotes[iso] || '';
      notes.addEventListener('input', (e) => {
        dailyNotes[iso] = e.target.value.trim();
        if (dailyNotes[iso] === '') delete dailyNotes[iso];
        saveData();
      });
      notes.addEventListener('click', (e) => { e.stopPropagation(); });
      cell.appendChild(notes);
    }
    targetGrid.appendChild(cell);
  }
}

// --- æ”¶é›†æ•¸æ“š (ç”¨æ–¼è¼¸å‡º) ---
function collectRows(isoDates){
  const rows = [];
  for(const iso of isoDates){
    const tripFive = triplet(iso);
    const tripThree = tripletThreeTeam(iso);
    rows.push({
      iso,
      tripletFive: tripFive,
      tripletThree: tripThree, 
      note: dailyNotes[iso] || ''
    });
  }
  return rows;
}

// --- è¼¸å‡º CSV åŠŸèƒ½ ---
function exportCSV(rows){
  const header = ['æ—¥æœŸ', '12å°æ™‚å·¥ä½œ', '24å°æ™‚å·¥ä½œ', 'å‚™è¨»'];
  const lines = [header.join(',')];
  for(const r of rows){
    const cells = [ 
      r.iso, 
      r.tripletFive.join(' '), 
      r.tripletThree.join(' '), 
      r.note || '' 
    ].map(v => String(v).replaceAll('"','""'));
    lines.push(cells.map(v => /[",\n]/.test(v) ? `"${v}"` : v).join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='calendar_notes_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}

// ---- ä¸»è¦åŸ·è¡Œï¼šç­‰ DOM Ready ----
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  
  const mainWrap = document.getElementById('mainWrap');
  const monthPick = document.getElementById('monthPick');
  const prevM = document.getElementById('prevM');
  const nextM = document.getElementById('nextM');
  const btnExport = document.getElementById('btnExport');
  const modalCloseBtn = document.getElementById('customAlertClose');
  const modalBackdrop = document.getElementById('customAlert');
  
  const btnAddMarker = document.getElementById('btnAddMarker');
  const markerModal = document.getElementById('markerModal');
  const btnCancelMarker = document.getElementById('btnCancelMarker');
  const btnSaveMarker = document.getElementById('btnSaveMarker');
  
  const btnHelp = document.getElementById('btnHelp');
  const helpModal = document.getElementById('helpModal');
  const btnCloseHelp = document.getElementById('btnCloseHelp');
  const btnExportText = document.getElementById('btnExportText');
  
  const btnToggle12hr = document.getElementById('btnToggle12hr');
  const btnToggle24hr = document.getElementById('btnToggle24hr');
  const markerInfoModal = document.getElementById('markerInfoModal');
  const btnCloseMarkerInfo = document.getElementById('btnCloseMarkerInfo');
  const btnDeleteMarker = document.getElementById('btnDeleteMarker');

  const btnShowFilter = document.getElementById('btnShowFilter');
  const filterModal = document.getElementById('filterModal');
  const btnApplyFilter = document.getElementById('btnApplyFilter');
  const btnClearFilter = document.getElementById('btnClearFilter');
  const btnCancelFilter = document.getElementById('btnCancelFilter');
  const filterTypeRadios = document.querySelectorAll('input[name="filterType"]');
  const filterOptions12hr = document.getElementById('filterOptions12hr');
  const filterOptions24hr = document.getElementById('filterOptions24hr');


  let currentGrid = document.getElementById('grid');
  let isAnimating = false;
  
  mainWrap.style.position = 'relative';
  mainWrap.style.overflowX = 'hidden';

  if (!currentGrid || !btnToggle12hr || !btnToggle24hr || !markerInfoModal || !btnShowFilter) {
      console.error('Initialization failed: Missing critical DOM elements.');
      return;
  }
  
  btnToggle12hr.dataset.on = showFiveTeam ? '1' : '0';
  btnToggle24hr.dataset.on = showThreeTeam ? '1' : '0';

  const t = new Date(TODAY_ISO+'T00:00:00');
  const startYear = t.getFullYear();
  const startMonthIndex = t.getMonth();
  monthPick.value = `${startYear}-${(startMonthIndex + 1).toString().padStart(2, '0')}`;
  
  const todayDow = t.getDay();
  const weekbarDivs = document.querySelectorAll('#weekbar div');
  if (weekbarDivs[todayDow]) {
      weekbarDivs[todayDow].classList.add('is-today');
  }

  // --- åˆ‡æ›æœˆä»½æ ¸å¿ƒå‡½æ•¸ (å¸¶å‹•ç•«) ---
  function changeMonth(direction) {
      if (isAnimating) return;
      isAnimating = true;

      const [y, m] = monthPick.value.split('-').map(Number);
      const d = new Date(y, m - 1, 1);
      d.setMonth(d.getMonth() + direction);
      
      const newY = d.getFullYear();
      const newM_idx = d.getMonth();
      
      monthPick.value = `${newY}-${(newM_idx + 1).toString().padStart(2, '0')}`;

      const newGrid = document.createElement('div');
      newGrid.className = 'grid'; newGrid.id = 'grid';

      render(newGrid, newY, newM_idx); 
      
      const oldGrid = currentGrid;
      oldGrid.id = 'grid-old';
      
      mainWrap.appendChild(newGrid);
      currentGrid = newGrid;
      
      let animationEnded = false;
      const onAnimEnd = () => {
          if (animationEnded) return;
          animationEnded = true;
          if (document.body.contains(oldGrid)) {
            oldGrid.remove();
          }
          isAnimating = false;
      };
      
      oldGrid.addEventListener('animationend', onAnimEnd);
      setTimeout(onAnimEnd, 450); // Fallback

      requestAnimationFrame(() => {
          if (direction > 0) {
              oldGrid.classList.add('animate-out-left');
              newGrid.classList.add('animate-in-right');
          } else {
              oldGrid.classList.add('animate-out-right');
              newGrid.classList.add('animate-in-left');
          }
      });
  }
  
  // --- ç¶å®šäº‹ä»¶ ---
  prevM.addEventListener('click', () => changeMonth(-1));
  nextM.addEventListener('click', () => changeMonth(1));
  
  monthPick.addEventListener('change', () => {
      if (isAnimating) {
          if (currentGrid.dataset.year && currentGrid.dataset.monthIndex) {
              const y_s = currentGrid.dataset.year;
              const m_idx_s = currentGrid.dataset.monthIndex;
              monthPick.value = `${y_s}-${(parseInt(m_idx_s, 10) + 1).toString().padStart(2, '0')}`;
          }
          return; 
      }
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  // è¼¸å‡º CSV
  btnExport.addEventListener('click', ()=>{
    if (isAnimating) return;
    const isoDatesWithNotes = Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== '');
    if(isoDatesWithNotes.length === 0 && Object.keys(customMarkers).length === 0){ 
      showModal('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€é …å‚™è¨»æˆ–æ¨™è¨˜ã€‚');
      return; 
    }
    const allDates = new Set([...Object.keys(dailyNotes), ...Object.keys(customMarkers)]);
    const sortedDates = Array.from(allDates).sort();
    
    const rows = collectRows(sortedDates);
    exportCSV(rows);
  });

  // æç¤º Modal
  modalCloseBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  
  // æ–°å¢æ¨™è¨˜ Modal
  btnAddMarker.addEventListener('click', () => { 
    if (isAnimating) return;
    showMarkerModal(); 
  });
  btnCancelMarker.addEventListener('click', closeMarkerModal);
  markerModal.addEventListener('click', (e) => {
    if (e.target === markerModal) closeMarkerModal();
  });
  btnSaveMarker.addEventListener('click', () => {
      const date = document.getElementById('markerDate').value;
      const desc = document.getElementById('markerDesc').value;
      const color = document.querySelector('input[name="markerColor"]:checked').value;
      
      if (!date || !desc) {
          showModal('è«‹å¡«å¯«æ—¥æœŸå’Œèªªæ˜ã€‚');
          return;
      }
      
      customMarkers[date] = { description: desc, color: color };
      saveData();
      closeMarkerModal();
      
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });
  
  // å¹«åŠ© Modal
  btnHelp.addEventListener('click', () => {
    if (isAnimating) return;
    showHelpModal();
  });
  btnCloseHelp.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) closeHelpModal();
  });
  
  // --- 12/24å°æ™‚ åˆ‡æ›äº‹ä»¶ ---
  btnToggle12hr.addEventListener('click', () => {
      if (isAnimating) return;
      showFiveTeam = !showFiveTeam;
      btnToggle12hr.dataset.on = showFiveTeam ? '1' : '0';
      
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  btnToggle24hr.addEventListener('click', () => {
      if (isAnimating) return;
      showThreeTeam = !showThreeTeam;
      btnToggle24hr.dataset.on = showThreeTeam ? '1' : '0';

      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  // --- åˆªé™¤æ¨™è¨˜ Modal äº‹ä»¶ ---
  btnCloseMarkerInfo.addEventListener('click', closeMarkerInfoModal);
  markerInfoModal.addEventListener('click', (e) => {
      if (e.target === markerInfoModal) closeMarkerInfoModal();
  });
  btnDeleteMarker.addEventListener('click', () => {
      if (currentMarkerISO) {
          delete customMarkers[currentMarkerISO];
          saveData();
          closeMarkerInfoModal();
          const [y, m] = monthPick.value.split('-').map(Number);
          render(currentGrid, y, m - 1);
      }
  });
  
  // --- æ–°å¢ï¼šç¯©é¸ Modal äº‹ä»¶ ---
  btnShowFilter.addEventListener('click', () => {
      if (isAnimating) return;
      showFilterModal();
  });

  filterTypeRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
          // --- (FIX) ä¿®æ­£ 'e.g.target' éŒ¯èª¤ ---
          filterOptions12hr.style.display = (e.target.value === '12hr') ? 'block' : 'none';
          filterOptions24hr.style.display = (e.target.value === '24hr') ? 'block' : 'none';
      });
  });

  btnCancelFilter.addEventListener('click', closeFilterModal);
  filterModal.addEventListener('click', (e) => {
      if (e.target === filterModal) closeFilterModal();
  });

  btnClearFilter.addEventListener('click', () => {
      filterState = { type: 'none', letter12: 'none', number12: 'none', letter24: 'none' };
      closeFilterModal();
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });
  
  btnApplyFilter.addEventListener('click', () => {
      filterState.type = document.querySelector('input[name="filterType"]:checked').value;
      filterState.letter12 = document.querySelector('input[name="filter12Letter"]:checked').value;
      filterState.number12 = document.querySelector('input[name="filter12Number"]:checked').value;
      filterState.letter24 = document.querySelector('input[name="filter24Letter"]:checked').value;
      
      closeFilterModal();
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });


  // --- è¼¸å‡ºæ–‡å­— ---
  btnExportText.addEventListener('click', () => {
      if (isAnimating) return;
      const allIsoDates = new Set([
          ...Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== ''), 
          ...Object.keys(customMarkers)
      ]);
      
      const sortedDates = Array.from(allIsoDates).sort();
      
      if (sortedDates.length === 0) {
          showModal('æ²’æœ‰ä»»ä½•å‚™è¨»æˆ–æ¨™è¨˜å¯ä¾›è¤‡è£½ã€‚');
          return;
      }

      let output = "ğŸ“… ä½ çš„æ—¥æ›†åŒ¯å‡º\n--------------------\n\n";
      
      for (const iso of sortedDates) {
          const d = new Date(iso + 'T00:00:00');
          const weekday = d.toLocaleDateString('zh-HK', { weekday: 'short' });
          const note = dailyNotes[iso];
          const marker = customMarkers[iso];
          
          const year = d.getFullYear();
          const holidayMap = getHolidayMapForYear(year);
          const holiday = holidayMap.get(iso);

          const tripFive = triplet(iso);
          const tripThree = tripletThreeTeam(iso);

          output += `${iso} (${weekday})\n`;
          
          if (holiday) {
              output += `  - å‡æœŸ: ${holiday}\n`;
          }
          if (marker) {
              const colorName = marker.color === 'blue' ? 'è—è‰²' : 'ç¶ è‰²';
              output += `  - æ¨™è¨˜: ${marker.description} (${colorName})\n`;
          }
          if (note && note.trim() !== '') {
              output += `  - å‚™è¨»: ${note}\n`;
          }
          output += `  - 12å°æ™‚: ${tripFive.join(', ')}\n`;
          output += `  - 24å°æ™‚: ${tripThree.join(', ')}\n`;
          output += '\n';
      }
      
      output += "--------------------";
      copyToClipboard(output);
  });


  // --- åˆå§‹ Render ---
  render(currentGrid, startYear, startMonthIndex);
});
</script>
</body>
</html>


