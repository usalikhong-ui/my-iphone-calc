<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ABCDE æœˆæ›†ï¼ˆå‚™è¨»ç‰ˆï¼‰</title>
<!-- 
  v3 - 2025-11-09
  1.  é‡å¯« JavaScript å˜… triplet() å‡½æ•¸ï¼Œä»¥ç¬¦åˆç”¨æˆ¶æœ€æ–°æ’åºé‚è¼¯: 
      [Anchor(date), Anchor(date-1), Anchor(date-2)]
  2.  æ›´æ–° render() å‡½æ•¸ï¼Œå‚³é dateISO (è€Œé letter, number) åˆ° triplet()ã€‚
  3.  æ›´æ–° helpModal å¹«åŠ©é¸å–®ä¸­å˜…ç¯©é¸èªªæ˜ã€‚
  4.  èª¿æ•´ CSS å˜… padding, gap, åŒ font-sizeï¼Œæ”¹å–„æ‰‹æ©Ÿé¡¯ç¤ºã€‚
-->
<style>
  :root{
    --bg: #0b1220;
    --panel: rgba(255,255,255,.08);
    --card: rgba(255,255,255,.12);
    --stroke: rgba(255,255,255,.18);
    --txt: #f6f7fb;
    --muted: #c5cbd6;
    --accent: #7dd3fc;
    --today: #ffd166;
    --weekbar: #364156;
    --holiday: #e11d48;
    --marker-blue: #3b82f6;
    --marker-green: #22c55e;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang HK",
        "Noto Sans HK","Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;
        background: linear-gradient(180deg, #0a0f19, #0b1220 30%, #0b1220 100%); color:var(--txt); }
  header{ position:sticky; top:0; z-index:5; background: rgba(11,18,32,.75);
          backdrop-filter: blur(10px); border-bottom:1px solid var(--stroke); }
  
  /* --- CSS ä¿®æ­£ï¼šæ¸›å°‘ padding --- */
  .wrap{ max-width:1100px; margin:0 auto; padding:8px; }
  
  .top-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
  }
  .top-filters {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .chip-group {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }
  .button-group {
    display: flex;
    gap: 10px;
    margin-left: auto; /* å°‡æ‰€æœ‰æŒ‰éˆ•æ¨åˆ°æœ€å³ */
    flex-shrink: 0;
  }
  .btn-add-marker {
    padding: 6px 10px;
    font-size: 13px;
    background: var(--accent);
    color: var(--bg);
    border: none;
  }
  .btn-help {
    background: var(--today);
    color: var(--bg);
    font-weight: 600;
    border: none;
  }
  
  .title {
    flex-grow: 1;
    text-align: center;
  }
  
  .navbtn{ 
    background: var(--panel); border:1px solid var(--stroke); padding:8px;
    border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink: 0;
  }
  .title{ font-weight:700; letter-spacing:.5px; padding:6px 10px; border-radius:10px; background:var(--panel); border:1px solid var(--stroke); }
  input[type="month"]{ background:transparent; color:var(--txt); border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px; outline:none; flex-shrink: 0; }
  .chip{ padding:6px 12px; border-radius:999px; background: var(--panel); border:1px solid var(--stroke); cursor:pointer; user-select:none; }
  .chip[data-on="1"]{ outline:2px solid var(--accent); }
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--panel); color:var(--txt); cursor:pointer; }
  .btn:hover{ outline:2px solid var(--accent); }
  
  .weekbar{ display:grid; grid-template-columns: repeat(7,1fr); background: var(--weekbar); border-radius:10px; overflow:hidden; margin-top:10px; }
  .weekbar div{ text-align:center; padding:8px 0; font-size:12px; color:#e7eaf1; transition: color 0.2s; }
  .weekbar div.is-today {
    color: var(--today);
    font-weight: 700;
  }
  
  /* --- CSS ä¿®æ­£ï¼šæ¸›å°‘ gap --- */
  .grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:4px; margin-top:8px; }
  
  /* --- CSS ä¿®æ­£ï¼šæ¸›å°‘ padding åŒ gap --- */
  .cell{ min-height:120px; background: var(--card); border:1px solid var(--stroke); border-radius:10px; padding:6px;
         display:flex; flex-direction:column; gap:4px; transition: opacity .2s, border-color .2s; cursor:pointer; }
  .cell.dim{ opacity:.35; }
  
  .cell.filtered-dim { opacity: .35; }
  
  .dhead{ display:flex; align-items:center; justify-content:space-between; }
  .dnum{ font-weight:700; }
  .dnum.today{ outline:2px solid var(--today); border-radius:8px; padding:2px 6px; }

  .cell.is-holiday {
    border-left: 3px solid var(--holiday);
    padding-left: 6px;
  }
  .cell.is-marker {
    border-left-width: 3px;
    padding-left: 6px;
  }

  .trip{ display:flex; flex-direction:column; gap:2px; }
  
  /* --- CSS ä¿®æ­£ï¼šç¸®å°å­—é«”, æ¸›å°‘ letter-spacing --- */
  .code{ font-weight:800; letter-spacing:0.1px; font-size: 13px; }
  
  /* é¡è‰²å®šç¾© */
  .A{ color:#3b82f6;} 
  .B{ color:#f59e0b;} 
  .C{ color:#22c55e;} 
  .D{ color:#8b5cf6;} 
  .E{ color:#fb7185;}
  
  .notes-input{
    margin-top:auto;
    width:100%;
    background: var(--panel);
    border:1px solid var(--stroke);
    border-radius:6px;
    color: var(--txt);
    padding:4px 6px;
    font-size:11px;
    outline: none;
    cursor:text;
  }
  .notes-input::placeholder{ color: var(--muted); opacity: 0.6; }
  .notes-input:focus{ outline:1px solid var(--accent); }

  .modal-backdrop {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity .2s;
  }
  .modal-backdrop.show {
    opacity: 1; pointer-events: auto;
  }
  .modal-content {
    background: #1c2536;
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
    max-width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .modal-content p {
    text-align: center;
    margin-top: 0;
  }
  .modal-content button {
    margin-top: 15px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .modal-content h3 {
    margin-top: 0;
    text-align: left;
  }
  .modal-content ul {
    text-align: left;
    padding-left: 20px;
    color: var(--muted);
  }
  .modal-content li {
    margin-bottom: 10px;
    line-height: 1.5;
  }
  .modal-content code {
    background: var(--panel);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 15px;
    text-align: left;
  }
  .form-group label {
    font-size: 13px;
    color: var(--muted);
  }
  .form-group input, .form-group select {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    padding: 8px 10px;
    color: var(--txt);
    outline: none;
  }
  .form-group input:focus, .form-group select:focus {
    outline: 1px solid var(--accent);
  }
  .color-select {
    display: flex;
    gap: 10px;
  }
  .color-select label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .color-dot {
    width: 16px; height: 16px;
    border-radius: 50%;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .modal-actions button.secondary {
    background: var(--panel);
    color: var(--txt);
  }
  
  /* å‹•ç•« */
  @keyframes bounce-in-right {
      0% { transform: translateX(100%); opacity: 0; }
      60% { transform: translateX(-10%); opacity: 1; }
      80% { transform: translateX(5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-left {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
  }
  @keyframes bounce-in-left {
      0% { transform: translateX(-100%); opacity: 0; }
      60% { transform: translateX(10%); opacity: 1; }
      80% { transform: translateX(-5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-right {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
  }

  .grid.animate-in-right { animation: bounce-in-right 0.4s ease-out forwards; }
  .grid.animate-out-left { animation: bounce-out-left 0.4s ease-out forwards; }
  .grid.animate-in-left { animation: bounce-in-left 0.4s ease-out forwards; }
  .grid.animate-out-right { animation: bounce-out-right 0.4s ease-out forwards; }
  
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top-controls">
      <button class="navbtn" id="prevM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <div class="title" id="title"></div>
      <button class="navbtn" id="nextM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
      <input type="month" id="monthPick">
    </div>
    <div class="top-filters">
      <div class="chip-group">
        <div class="chip" data-on="0" data-letter="A">A</div>
        <div class="chip" data-on="0" data-letter="B">B</div>
        <div class="chip" data-on="0" data-letter="C">C</div>
        <div class="chip" data-on="0" data-letter="D">D</div>
        <div class="chip" data-on="0" data-letter="E">E</div>
      </div>
      <div class="button-group">
        <button class="btn btn-help" id="btnHelp">èªªæ˜</button>
        <button class="btn btn-add-marker" id="btnAddMarker">+ æ¨™è¨˜</button>
        <button class="btn" id="btnExportText">è¼¸å‡ºæ–‡å­—</button>
        <button class="btn" id="btnExport">è¼¸å‡º CSV</button>
      </div>
    </div>
    <div class="weekbar" id="weekbar">
      <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
  </div>
</header>

<main class="wrap" id="mainWrap">
  <div class="grid" id="grid"></div>
</main>

<!-- å½ˆçª— (æç¤º) -->
<div class="modal-backdrop" id="customAlert">
  <div class="modal-content">
    <p id="customAlertMsg"></p>
    <button id="customAlertClose">æ˜ç™½</button>
  </div>
</div>

<!-- å½ˆçª— (æ–°å¢æ¨™è¨˜) -->
<div class="modal-backdrop" id="markerModal">
  <div class="modal-content">
    <h3>æ–°å¢è‡ªè¨‚æ¨™è¨˜</h3>
    <div class="form-group">
      <label for="markerDate">æ—¥æœŸ</label>
      <input type="date" id="markerDate">
    </div>
    <div class="form-group">
      <label for="markerDesc">èªªæ˜</label>
      <input type="text" id="markerDesc" placeholder="e.g. è¦†è¨º">
    </div>
    <div class="form-group">
      <label>é¡è‰²</label>
      <div class="color-select">
        <label>
          <input type="radio" name="markerColor" value="blue" checked>
          <span class="color-dot" style="background: var(--marker-blue);"></span> è—è‰²
        </label>
        <label>
          <input type="radio" name="markerColor" value="green">
          <span class="color-dot" style="background: var(--marker-green);"></span> ç¶ è‰²
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="secondary" id="btnCancelMarker">å–æ¶ˆ</button>
      <button id="btnSaveMarker">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- å½ˆçª— (å¹«åŠ©èªªæ˜) -->
<div class="modal-backdrop" id="helpModal">
  <div class="modal-content">
    <h3>ä½¿ç”¨èªªæ˜</h3>
    <ul>
      <!-- --- æ’åºé‚è¼¯ä¿®æ­£ï¼šæ›´æ–°æ­¤è™•èªªæ˜ --- -->
      <li><b>é€±æœŸç¯©é¸ (A-E)</b>: é»æ“Š <code>A</code> è‡³ <code>E</code> æŒ‰éˆ•ï¼Œæ—¥æ›†å°‡é«˜äº®é¡¯ç¤º *ç•¶æ—¥*ã€*å‰ä¸€æ—¥* æˆ– *å†å‰ä¸€æ—¥* ç­æ¬¡åŒ…å«è©²å­—æ¯å˜…æ—¥å­ã€‚</li>
      <li><b>è‡ªå‹•å„²å­˜</b>: åœ¨æ—¥æœŸæ ¼åº•éƒ¨è¼¸å…¥çš„ã€Œå‚™è¨»ã€ï¼Œå°‡æœƒè‡ªå‹•å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸‹æ¬¡é–‹å•Ÿæ™‚è³‡æ–™å°‡è‡ªå‹•è¼‰å…¥ã€‚</li>
      <li><b>å…¬çœ¾å‡æœŸ</b>: å·¦å´å¸¶æœ‰<code>ç´…è‰²</code>é‚Šæ¡†çš„æ—¥æœŸç‚ºé¦™æ¸¯å…¬çœ¾å‡æœŸï¼Œé»æ“Šè©²æ—¥æœŸæ ¼å¯æŸ¥çœ‹å‡æœŸåç¨±ã€‚</li>
      <li><b>è‡ªè¨‚æ¨™è¨˜</b>: é»æ“Š <code>+ æ¨™è¨˜</code> æŒ‰éˆ•ï¼Œå³å¯é¸å®šæ—¥æœŸã€é¡è‰² (è—/ç¶ ) åŠè¼¸å…¥èªªæ˜ã€‚å·²æ¨™è¨˜çš„æ—¥æœŸå°‡é¡¯ç¤ºç›¸æ‡‰é¡è‰²é‚Šæ¡†ï¼Œé»æ“Šå¾Œå¯æŸ¥é–±è©²èªªæ˜ã€‚</li>
      <li><b>è¼¸å‡ºæ–‡å­—</b>: é»æ“Š <code>è¼¸å‡ºæ–‡å­—</code> æŒ‰éˆ•ï¼Œç³»çµ±æœƒå°‡ *æ‰€æœ‰* å‚™è¨»åŠæ¨™è¨˜æ•´åˆç‚ºç´”æ–‡å­—æ ¼å¼ (é©åˆå³æ™‚é€šè¨Šè»Ÿä»¶)ï¼Œä¸¦è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚</li>
      <li><b>è¼¸å‡º CSV</b>: é»æ“Š <code>è¼¸å‡º CSV</code> æŒ‰éˆ•ï¼Œç³»çµ±å°‡å°å‡ºä¸€å€‹ .csv æª”æ¡ˆï¼Œæ­¤æª”æ¡ˆåƒ…åŒ…å« *å·²å¡«å¯«å‚™è¨»* çš„æ—¥æœŸï¼Œæ–¹ä¾¿ä½¿ç”¨ Excel æˆ– Google Sheets é€²è¡Œå¾ŒçºŒè™•ç†ã€‚</li>
    </ul>
    <button id="btnCloseHelp">æ˜ç™½</button>
  </div>
</div>


<script>
// ---- å›ºå®šè¦å‰‡ï¼šä»Šæ—¥ 2025-11-09 = C6 ----
// å‘¢å€‹ä¿‚è¨ˆç®—æ‰€æœ‰æ—¥æœŸå˜…åŸºæº–é»
const LETTERS = ['A','B','C','D','E'];
const TODAY_ISO = '2025-11-09';
const ANCHOR_LETTER = 'C';
const ANCHOR_NUMBER = 6;

// --- å…§ç½®å‡æœŸè³‡æ–™åº« (2024-2026) ---
const HOLIDAY_DATA = {
    "2024": {
        "2024-01-01": "å…ƒæ—¦",
        "2024-02-10": "è¾²æ›†å¹´åˆä¸€",
        "2024-02-12": "è¾²æ›†å¹´åˆä¸‰",
        "2024-02-13": "è¾²æ›†å¹´åˆå››",
        "2024-03-29": "è€¶ç©Œå—é›£ç¯€",
        "2024-03-30": "è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥",
        "2024-04-01": "å¾©æ´»ç¯€æ˜ŸæœŸä¸€",
        "2024-04-04": "æ¸…æ˜ç¯€",
        "2024-05-01": "å‹å‹•ç¯€",
        "2024-05-15": "ä½›èª•",
        "2024-06-10": "ç«¯åˆç¯€",
        "2024-07-01": "é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥",
        "2024-09-18": "ä¸­ç§‹ç¯€ç¿Œæ—¥",
        "2024-10-01": "åœ‹æ…¶æ—¥",
        "2024-10-11": "é‡é™½ç¯€",
        "2024-12-25": "è–èª•ç¯€",
        "2024-12-26": "è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥"
    },
    "2025": {
        "2025-01-01": "å…ƒæ—¦",
        "2025-01-29": "è¾²æ›†å¹´åˆä¸€",
        "2025-01-30": "è¾²æ›†å¹´åˆäºŒ",
        "2025-01-31": "è¾²æ›†å¹´åˆä¸‰",
        "2025-04-18": "è€¶ç©Œå—é›£ç¯€",
        "2025-04-19": "è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥",
        "2025-04-21": "å¾©æ´»ç¯€æ˜ŸæœŸä¸€",
        "2025-04-04": "æ¸…æ˜ç¯€",
        "2025-05-01": "å‹å‹•ç¯€",
        "2025-05-05": "ä½›èª•",
        "2025-05-31": "ç«¯åˆç¯€",
        "2025-07-01": "é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥",
        "2025-10-01": "åœ‹æ…¶æ—¥",
        "2025-10-07": "ä¸­ç§‹ç¯€ç¿Œæ—¥",
        "2025-10-30": "é‡é™½ç¯€",
        "2025-12-25": "è–èª•ç¯€",
        "2025-12-26": "è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥"
    },
    "2026": {
        "2026-01-01": "å…ƒæ—¦",
        "2026-02-17": "è¾²æ›†å¹´åˆä¸€",
        "2026-02-18": "è¾²æ›†å¹´åˆäºŒ",
        "2026-02-19": "è¾²æ›†å¹´åˆä¸‰",
        "2026-04-03": "è€¶ç©Œå—é›£ç¯€",
        "2026-04-04": "è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥",
        "2026-04-06": "å¾©æ´»ç¯€æ˜ŸæœŸä¸€",
        "2026-04-04": "æ¸…æ˜ç¯€", // æ¸…æ˜ç¯€èˆ‡è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥é‡ç–Š
        "2026-05-01": "å‹å‹•ç¯€",
        "2026-05-25": "ä½›èª•",
        "2026-06-19": "ç«¯åˆç¯€",
        "2026-07-01": "é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥",
        "2026-09-26": "ä¸­ç§‹ç¯€ç¿Œæ—¥",
        "2026-10-01": "åœ‹æ…¶æ—¥",
        "2026-10-02": "åœ‹æ…¶æ—¥ç¿Œæ—¥",
        "2026-10-19": "é‡é™½ç¯€",
        "2026-12-25": "è–èª•ç¯€"
    }
};

// ---- Global æ•¸æ“šå„²å­˜ ----
let dailyNotes = {}; 
let customMarkers = {};
let holidaysCache = new Map(); 

// ---- å„²å­˜/è®€å–åŠŸèƒ½ (LocalStorage) ----
function saveData() {
    try {
        localStorage.setItem('calendarNotes', JSON.stringify(dailyNotes));
        localStorage.setItem('calendarMarkers', JSON.stringify(customMarkers));
    } catch (e) {
        console.error('Failed to save data', e);
        showModal('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç©ºé–“å¯èƒ½å·²æ»¿ã€‚');
    }
}
function loadData() {
    const notes = localStorage.getItem('calendarNotes');
    const markers = localStorage.getItem('calendarMarkers');
    try {
      if (notes) {
          dailyNotes = JSON.parse(notes) || {};
      }
      if (markers) {
          customMarkers = JSON.parse(markers) || {};
      }
    } catch (e) {
      console.error('Failed to parse saved data', e);
      dailyNotes = {};
      customMarkers = {};
    }
}

// ---- å·¥å…·å‡½æ•¸ ----
function fmtISO(d){ // æ—¥æœŸç‰©ä»¶ è½‰ ISOå­—ä¸² (YYYY-MM-DD)
  const y = d.getFullYear();
  const m = (d.getMonth() + 1).toString().padStart(2, '0');
  const day = d.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function daysBetween(aISO,bISO){ // è¨ˆç®—å…©å€‹ ISO æ—¥æœŸä¹‹é–“å˜…æ—¥æ•¸
  return Math.round((new Date(bISO)-new Date(aISO))/86400000); 
}
function mod(a,b){ // æ¨¡æ•¸é‹ç®— (è™•ç†è² æ•¸)
  return ((a % b)+b)%b; 
}

// --- è¨ˆç®—ä¸»æ›´ (e.g. C6) ---
function letterNumFor(dateISO){
  const i0 = LETTERS.indexOf(ANCHOR_LETTER); // åŸºæº–å­—æ¯ 'C' å˜… index (2)
  const n = daysBetween(TODAY_ISO, dateISO); // è©²æ—¥èˆ‡åŸºæº–æ—¥å˜…å·®è·
  
  // è¨ˆç®—å­—æ¯ (A-E å¾ªç’°)
  const idx = mod(i0 - n, 5); // æ ¹æ“šå·®è·æ¨ç®—å­—æ¯ index
  
  // è¨ˆç®—æ•¸å­— (1-10 å¾ªç’°)
  const wraps = Math.floor((i0 + n)/5); // ä¼°ç®—ç¶“éå’—å¹¾å¤šå€‹5æ—¥é€±æœŸ
  let num = ANCHOR_NUMBER + wraps; // åŸºæº–æ•¸å­— (6) + é€±æœŸæ•¸
  num = ((num - 1) % 10 + 10) % 10 + 1; // ç¢ºä¿æ•¸å­—å–º 1-10 ä¹‹é–“å¾ªç’°
  
  return {letter: LETTERS[idx], number: num};
}

// --- ã€æ’åºé‚è¼¯ä¿®æ­£ - 2025-11-09ã€‘ ---
// æ ¹æ“šç”¨æˆ¶æœ€æ–°é‚è¼¯: Triplet(date) = [Anchor(date), Anchor(date-1), Anchor(date-2)]
function triplet(dateISO){
  const d = new Date(dateISO + 'T00:00:00'); // ç¢ºä¿ local time
  
  // 1. Anchor for today
  const {letter, number} = letterNumFor(dateISO);
  const t1 = `${letter}${number}`;
  
  // 2. Anchor for yesterday
  d.setDate(d.getDate() - 1);
  const iso_d1 = fmtISO(d);
  const {letter: l_d1, number: n_d1} = letterNumFor(iso_d1);
  const t2 = `${l_d1}${n_d1}`;
  
  // 3. Anchor for day before yesterday
  d.setDate(d.getDate() - 1);
  const iso_d2 = fmtISO(d);
  const {letter: l_d2, number: n_d2} = letterNumFor(iso_d2);
  const t3 = `${l_d2}${n_d2}`;
  
  return [t1, t2, t3];
}

// è¨ˆç®—æœˆæ›†ç¬¬ä¸€æ ¼ (å¯èƒ½ä¿‚ä¸Šå€‹æœˆ) å˜…æ—¥æœŸ
function firstCellDate(y, m){
  const first = new Date(y, m, 1);
  const startDow = first.getDay(); // 0 = Sun, 1 = Mon...
  return new Date(y, m, 1 - startDow);
}

// ç²å–ç•¶å‰å•Ÿå‹•å˜…ç¯©é¸ (A-E)
function currentFilter(){
  const chipElements = document.querySelectorAll('.chip');
  const set = new Set();
  for(const c of chipElements){ if(c.dataset.on==='1') set.add(c.dataset.letter); }
  return set;
}

// ---- Modal é¡¯ç¤º/éš±è— ----
function showModal(message) {
  const modal = document.getElementById('customAlert');
  const msg = document.getElementById('customAlertMsg');
  msg.textContent = message;
  modal.classList.add('show');
}
function closeModal() {
  const modal = document.getElementById('customAlert');
  modal.classList.remove('show');
}
function showMarkerModal(dateISO = '') {
    document.getElementById('markerDate').value = dateISO || fmtISO(new Date());
    document.getElementById('markerDesc').value = '';
    document.querySelector('input[name="markerColor"][value="blue"]').checked = true;
    document.getElementById('markerModal').classList.add('show');
}
function closeMarkerModal() {
    document.getElementById('markerModal').classList.remove('show');
}
function showHelpModal() {
    document.getElementById('helpModal').classList.add('show');
}
function closeHelpModal() {
    document.getElementById('helpModal').classList.remove('show');
}

// --- è¤‡è£½æ–‡å­—åˆ°å‰ªè²¼ç°¿ ---
function copyToClipboard(text) {
    const ta = document.createElement('textarea');
    ta.style.position = 'absolute';
    ta.style.left = '-9999px';
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try {
        // ä½¿ç”¨èˆŠæ–¹æ³• execCommand ç¢ºä¿å–º iFrame/WebView å˜…å…¼å®¹æ€§
        document.execCommand('copy');
        showModal('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    } catch (err) {
        console.error('Failed to copy text: ', err);
        showModal('è¤‡è£½å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
    }
    document.body.removeChild(ta);
}

// --- ç²å–è©²å¹´ä»½å˜…å‡æœŸ (ä½¿ç”¨å…§ç½®è³‡æ–™) ---
function getHolidayMapForYear(year) {
    const yearStr = String(year);
    if (holidaysCache.has(yearStr)) { // å„ªå…ˆç”±å¿«å–è®€å–
        return holidaysCache.get(yearStr);
    }
    
    // æª¢æŸ¥å…§ç½®è³‡æ–™
    if (HOLIDAY_DATA[yearStr]) {
        const holidayMap = new Map();
        for (const [iso, name] of Object.entries(HOLIDAY_DATA[yearStr])) {
            holidayMap.set(iso, name);
        }
        holidaysCache.set(yearStr, holidayMap); // å­˜å…¥å¿«å–
        return holidayMap;
    } else {
        // å¦‚æœå¹´ä»½è¶…å‡ºç¯„åœ (e.g. 2027)
        return new Map(); // è¿”å›ç©º Map
    }
}


// ---- æ ¸å¿ƒ Render å‡½æ•¸ (ç¹ªè£½æœˆæ›†) ----
function render(targetGrid, y, m_idx){
  const title = document.getElementById('title');
  targetGrid.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
  if (isNaN(y) || isNaN(m_idx)) { return; } // å®‰å…¨æª¢æŸ¥
  
  // è¨­å®šæ¨™é¡Œ (e.g., 2025å¹´ åä¸€æœˆ)
  title.textContent = new Date(y, m_idx, 1).toLocaleString('zh-HK',{year:'numeric', month:'long'});
  
  // ç²å–è©²å¹´å‡æœŸ
  const yearHolidayMap = getHolidayMapForYear(y);
  
  const base = firstCellDate(y, m_idx); // æœˆæ›†å·¦ä¸Šè§’ç¬¬ä¸€æ ¼å˜…æ—¥æœŸ
  const filter = currentFilter(); // ç•¶å‰ A-E ç¯©é¸
  
  for(let i=0;i<42;i++){ // ç¹ªè£½ 42 æ ¼ (6è¡Œ x 7æ—¥)
    const d = new Date(base); d.setDate(base.getDate()+i);
    const iso = fmtISO(d); 
    const inMonth = d.getMonth()===m_idx; // å‘¢æ ¼ä¿‚å’ªå±¬æ–¼ä»Šå€‹æœˆ
    
    // è¨ˆç®—ä¸»æ›´ (e.g., C6)
    const {letter, number} = letterNumFor(iso);
    
    // --- ã€æ’åºé‚è¼¯ä¿®æ­£ã€‘---
    // ç²å–ç•¶æ—¥, å‰ä¸€æ—¥, å†å‰ä¸€æ—¥å˜… Anchor
    const trip = triplet(iso); 
    
    const holiday = yearHolidayMap.get(iso) || ''; 
    const marker = customMarkers[iso];

    const cell = document.createElement('div');
    cell.className = 'cell' + (inMonth ? '' : ' dim'); //éæœ¬æœˆæ—¥æœŸè®Šæš—
    cell.dataset.iso = iso; cell.dataset.letter=letter; // ä¸»æ›´å­—æ¯
    
    // è™•ç†å‡æœŸ / æ¨™è¨˜ å˜…æ¨£å¼åŒé»æ“Šäº‹ä»¶
    if (holiday) {
        cell.classList.add('is-holiday');
        cell.addEventListener('click', () => { showModal(holiday); });
    } else if (marker) {
        cell.classList.add('is-marker');
        cell.style.borderColor = `var(--marker-${marker.color})`;
        cell.addEventListener('click', () => { showModal(marker.description); });
    }
    
    // è™•ç†ç¯©é¸ (A-E)
    if(filter.size > 0 && inMonth) {
      // --- ã€æ’åºé‚è¼¯ä¿®æ­£ã€‘---
      // æª¢æŸ¥ [C6, D6, E6] å˜…ç¬¬ä¸€å€‹å­—æ¯
      const tripLetters = trip.map(code => code[0]); // e.g., [C, D, E]
      const hasMatch = tripLetters.some(l => filter.has(l));
      if (!hasMatch) {
        cell.classList.add('filtered-dim'); // å¦‚æœå†‡ä¸­ï¼Œæˆæ ¼è®Šæš—
      }
    }

    // é¡¯ç¤ºæ—¥æœŸæ•¸å­—
    const head = document.createElement('div'); head.className='dhead';
    const num = document.createElement('div'); num.className='dnum' + (iso === TODAY_ISO ? ' today' : '');
    num.textContent = d.getDate();
    head.appendChild(num);
    head.appendChild(document.createElement('div'));
    cell.appendChild(head);

    // å¦‚æœä¿‚æœ¬æœˆæ—¥æœŸï¼Œå…ˆé¡¯ç¤ºç­æ¬¡åŒå‚™è¨»
    if(inMonth){
      const tp=document.createElement('div'); tp.className='trip';
      
      // --- ã€æ’åºé‚è¼¯ä¿®æ­£ã€‘---
      // é¡¯ç¤ºä¸‰å€‹ç­æ¬¡ï¼Œä¸¦ä¸Šè‰²
      trip.forEach(code=>{ 
        const div=document.createElement('div'); 
        div.className='code';
        
        // æå–ç¬¬ä¸€å€‹å­—æ¯ç”¨åšŸä¸Šè‰² (e.g., 'C6' -> 'C', 'D6' -> 'D')
        const letterForColor = code[0];
        div.classList.add(letterForColor); // ç”¨ CSS class (.A, .B, .C...) ä¸Šè‰²
        
        div.textContent=code; 
        tp.appendChild(div); 
      });
      cell.appendChild(tp);
      
      // å‚™è¨» input
      const notes = document.createElement('input');
      notes.type = 'text';
      notes.className = 'notes-input';
      notes.placeholder = 'åŠ å‚™è¨»...';
      notes.value = dailyNotes[iso] || '';
      notes.addEventListener('input', (e) => { // è‡ªå‹•å„²å­˜
        dailyNotes[iso] = e.target.value.trim();
        if (dailyNotes[iso] === '') delete dailyNotes[iso]; // å†‡å…§å®¹å°±åˆªå’—ä½¢
        saveData();
      });
      notes.addEventListener('click', (e) => { e.stopPropagation(); }); // é¿å…é» input = é»æˆæ ¼
      cell.appendChild(notes);
    }
    targetGrid.appendChild(cell);
  }
}

// --- æ”¶é›†æ•¸æ“š (ç”¨æ–¼è¼¸å‡º) ---
function collectRows(isoDates){
  const rows = [];
  for(const iso of isoDates){
    // const {letter, number} = letterNumFor(iso); // å””å†éœ€è¦
    const trip = triplet(iso); // ç²å– [C6, D6, E6]
    rows.push({
      iso,
      triplet: trip, // å„²å­˜æ‰€æœ‰ä¸‰å€‹ç­æ¬¡
      note: dailyNotes[iso] || ''
    });
  }
  return rows;
}

// --- è¼¸å‡º CSV åŠŸèƒ½ ---
function exportCSV(rows){
  const header = ['æ—¥æœŸ', 'é€±æœŸ', 'å‚™è¨»'];
  const lines = [header.join(',')];
  for(const r of rows){
    // CSV å˜…ã€Œé€±æœŸã€æ¬„æœƒé¡¯ç¤ºæ‰€æœ‰3å€‹ç­æ¬¡
    const cells = [ r.iso, r.triplet.join(' '), r.note || '' ]
      .map(v => String(v).replaceAll('"','""')); // è™•ç† "
    lines.push(cells.map(v => /[",\n]/.test(v) ? `"${v}"` : v).join(',')); // è™•ç† , åŒ æ›è¡Œ
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='calendar_notes_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}

// ---- ä¸»è¦åŸ·è¡Œï¼šç­‰ DOM Ready ----
document.addEventListener('DOMContentLoaded', () => {
  loadData(); // è¼‰å…¥å·²å„²å­˜å˜…å‚™è¨»åŒæ¨™è¨˜
  
  // ç²å–æ‰€æœ‰é‡è¦ DOM å…ƒç´ 
  const mainWrap = document.getElementById('mainWrap');
  const monthPick = document.getElementById('monthPick');
  const prevM = document.getElementById('prevM');
  const nextM = document.getElementById('nextM');
  const chips = Array.from(document.querySelectorAll('.chip'));
  const btnExport = document.getElementById('btnExport');
  const modalCloseBtn = document.getElementById('customAlertClose');
  const modalBackdrop = document.getElementById('customAlert');
  
  const btnAddMarker = document.getElementById('btnAddMarker');
  const markerModal = document.getElementById('markerModal');
  const btnCancelMarker = document.getElementById('btnCancelMarker');
  const btnSaveMarker = document.getElementById('btnSaveMarker');
  
  const btnHelp = document.getElementById('btnHelp');
  const helpModal = document.getElementById('helpModal');
  const btnCloseHelp = document.getElementById('btnCloseHelp');
  const btnExportText = document.getElementById('btnExportText');

  let currentGrid = document.getElementById('grid');
  let isAnimating = false; // é˜²æ­¢å‹•ç•«é‡ç–Š
  
  mainWrap.style.position = 'relative';
  mainWrap.style.overflowX = 'hidden';

  // ç¢ºä¿æ‰€æœ‰å˜¢éƒ½å­˜åœ¨
  if (!currentGrid || !monthPick || !prevM || !nextM || !btnExport || !btnAddMarker || !btnHelp || !btnExportText) {
      console.error('Initialization failed: Missing critical DOM elements.');
      return;
  }

  // è¨­å®šåˆå§‹æœˆä»½ (åŸºæº–æ—¥æ‰€åœ¨æœˆä»½)
  const t = new Date(TODAY_ISO+'T00:00:00');
  const startYear = t.getFullYear();
  const startMonthIndex = t.getMonth();
  monthPick.value = `${startYear}-${(startMonthIndex + 1).toString().padStart(2, '0')}`;
  
  // é«˜äº®æ˜ŸæœŸæ¬„å˜…ã€Œä»Šæ—¥ã€
  const todayDow = t.getDay();
  const weekbarDivs = document.querySelectorAll('#weekbar div');
  if (weekbarDivs[todayDow]) {
      weekbarDivs[todayDow].classList.add('is-today');
  }

  // --- åˆ‡æ›æœˆä»½æ ¸å¿ƒå‡½æ•¸ (å¸¶å‹•ç•«) ---
  function changeMonth(direction) { // direction: -1 = ä¸Š, 1 = ä¸‹
      if (isAnimating) return;
      isAnimating = true;

      // è¨ˆç®—æ–°æ—¥æœŸ
      const [y, m] = monthPick.value.split('-').map(Number);
      const d = new Date(y, m - 1, 1);
      d.setMonth(d.getMonth() + direction);
      
      const newY = d.getFullYear();
      const newM_idx = d.getMonth();
      
      monthPick.value = `${newY}-${(newM_idx + 1).toString().padStart(2, '0')}`;

      // å»ºç«‹æ–° grid
      const newGrid = document.createElement('div');
      newGrid.className = 'grid'; newGrid.id = 'grid';

      render(newGrid, newY, newM_idx); // ç¹ªè£½æ–°æœˆä»½
      
      const oldGrid = currentGrid;
      oldGrid.id = 'grid-old'; // æ¨™è¨˜èˆŠ grid
      
      mainWrap.appendChild(newGrid); // å°‡æ–° grid åŠ å…¥ DOM
      currentGrid = newGrid;
      
      // ç›£è½å‹•ç•«çµæŸäº‹ä»¶
      let animationEnded = false;
      const onAnimEnd = () => {
          if (animationEnded) return;
          animationEnded = true;
          if (document.body.contains(oldGrid)) {
            oldGrid.remove(); // ç§»é™¤èˆŠ grid
          }
          isAnimating = false;
      };
      
      oldGrid.addEventListener('animationend', onAnimEnd);
      setTimeout(onAnimEnd, 450); // Fallbackï¼Œç¢ºä¿å‹•ç•«ä¸€å®šæœƒå®Œ

      // è§¸ç™¼å‹•ç•«
      requestAnimationFrame(() => {
          if (direction > 0) { // ä¸‹å€‹æœˆ
              oldGrid.classList.add('animate-out-left');
              newGrid.classList.add('animate-in-right');
          } else { // ä¸Šå€‹æœˆ
              oldGrid.classList.add('animate-out-right');
              newGrid.classList.add('animate-in-left');
          }
      });
  }
  
  // --- ç¶å®šäº‹ä»¶ ---
  
  // æœˆä»½å°èˆª
  prevM.addEventListener('click', () => changeMonth(-1));
  nextM.addEventListener('click', () => changeMonth(1));
  
  // æœˆä»½é¸æ“‡å™¨
  monthPick.addEventListener('change', () => {
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  // A-E ç¯©é¸
  chips.forEach(c=>c.addEventListener('click', ()=>{
    c.dataset.on = c.dataset.on==='1' ? '0' : '1'; // åˆ‡æ›ç‹€æ…‹
    const [y, m] = monthPick.value.split('-').map(Number);
    render(currentGrid, y, m - 1); // é‡æ–° render
  }));

  // è¼¸å‡º CSV
  btnExport.addEventListener('click', ()=>{
    const isoDatesWithNotes = Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== '');
    if(isoDatesWithNotes.length === 0){ 
      showModal('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€é …å‚™è¨»ã€‚');
      return; 
    }
    const rows = collectRows(isoDatesWithNotes.sort()); // æ”¶é›†æ•¸æ“š
    exportCSV(rows);
  });

  // é—œé–‰æç¤º Modal
  modalCloseBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  
  // æ–°å¢æ¨™è¨˜ Modal
  btnAddMarker.addEventListener('click', () => { showMarkerModal(); });
  btnCancelMarker.addEventListener('click', closeMarkerModal);
  markerModal.addEventListener('click', (e) => {
    if (e.target === markerModal) closeMarkerModal();
  });
  btnSaveMarker.addEventListener('click', () => {
      const date = document.getElementById('markerDate').value;
      const desc = document.getElementById('markerDesc').value;
      const color = document.querySelector('input[name="markerColor"]:checked').value;
      
      if (!date || !desc) {
          showModal('è«‹å¡«å¯«æ—¥æœŸå’Œèªªæ˜ã€‚');
          return;
      }
      
      customMarkers[date] = { description: desc, color: color };
      saveData();
      closeMarkerModal();
      
      // é‡æ–° render é¡¯ç¤ºæ–°æ¨™è¨˜
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });
  
  // å¹«åŠ© Modal
  btnHelp.addEventListener('click', showHelpModal);
  btnCloseHelp.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) closeHelpModal();
  });
  
  // è¼¸å‡ºæ–‡å­—
  btnExportText.addEventListener('click', () => {
      // æ”¶é›†æ‰€æœ‰æœ‰å‚™è¨» æˆ– æœ‰æ¨™è¨˜ å˜…æ—¥æœŸ
      const allIsoDates = new Set([
          ...Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== ''), 
          ...Object.keys(customMarkers)
      ]);
      
      const sortedDates = Array.from(allIsoDates).sort(); // æ’åº
      
      if (sortedDates.length === 0) {
          showModal('æ²’æœ‰ä»»ä½•å‚™è¨»æˆ–æ¨™è¨˜å¯ä¾›è¤‡è£½ã€‚');
          return;
      }

      let output = "ğŸ“… ä½ çš„æ—¥æ›†åŒ¯å‡º\n--------------------\n\n";
      
      for (const iso of sortedDates) {
          const d = new Date(iso + 'T00:00:00');
          const weekday = d.toLocaleDateString('zh-HK', { weekday: 'short' });
          const note = dailyNotes[iso];
          const marker = customMarkers[iso];
          
          const year = d.getFullYear();
          const holidayMap = getHolidayMapForYear(year); // ç²å–å‡æœŸ
          const holiday = holidayMap.get(iso);

          output += `${iso} (${weekday})\n`;
          
          if (holiday) {
              output += `  - å‡æœŸ: ${holiday}\n`;
          }
          if (marker) {
              const colorName = marker.color === 'blue' ? 'è—è‰²' : 'ç¶ è‰²';
              output += `  - æ¨™è¨˜: ${marker.description} (${colorName})\n`;
          }
          if (note && note.trim() !== '') {
              output += `  - å‚™è¨»: ${note}\n`;
          }
          output += '\n'; // æ¯å€‹æ—¥æœŸå¾ŒåŠ ç©ºè¡Œ
      }
      
      output += "--------------------";
      copyToClipboard(output);
  });


  // --- åˆå§‹ Render ---
  // è¼‰å…¥é é¢æ™‚ï¼Œç¬¬ä¸€æ¬¡ç¹ªè£½æœˆæ›†
  render(currentGrid, startYear, startMonthIndex);
});
</script>
</body>
</html>