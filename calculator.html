<!DOCTYPE html>
<html lang="zh-HK">
<head>
<!-- 
  v5.14 - 2025-11-10
  1.  (FIX) 修正 parseImportedText() 嘅 Regex 規則，
      放寬 '標記: ' 同 '備註: ' 後面嘅空格要求，
      修正 v5.13 匯入 0 個項目嘅 bug。
  2.  (Confirm) 包含 v5.12 嘅所有修正 (真實日期高光, 語法錯誤, 排版, 刪除邏輯)。
-->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ABCDE 月曆（備註版）</title>
<style>
  :root{
    --bg: #0b1220;
    --panel: rgba(255,255,255,.08);
    --card: rgba(255,255,255,.12);
    --stroke: rgba(255,255,255,.18);
    --txt: #f6f7fb;
    --muted: #c5cbd6;
    --accent: #7dd3fc;
    --today: #ffd166;
    --weekbar: #364156;
    --holiday: #e11d48;
    --marker-blue: #3b82f6;
    --marker-green: #22c55e;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang HK",
        "Noto Sans HK","Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;
        background: linear-gradient(180deg, #0a0f19, #0b1220 30%, #0b1220 100%); color:var(--txt); }
  header{ position:sticky; top:0; z-index:5; background: rgba(11,18,32,.75);
          backdrop-filter: blur(10px); border-bottom:1px solid var(--stroke); }
  
  .wrap{ max-width:1100px; margin:0 auto; padding:8px; }
  
  .top-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
  }
  .top-filters {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  
  /* (v5.10 FIX) 修正 iPhone 排版溢出 */
  .button-group {
    display: flex;
    gap: 10px;
    /* 移除 margin-left: auto; */
    /* 移除 flex-shrink: 0; */
    flex-wrap: wrap; /* 換行 */
    justify-content: flex-end; /* 按鈕靠右 */
    width: 100%; /* 佔滿整行 */
  }
  .btn-add-marker {
    padding: 6px 10px;
    font-size: 13px;
    background: var(--accent);
    color: var(--bg);
    border: none;
  }
  .btn-help {
    background: var(--today);
    color: var(--bg);
    font-weight: 600;
    border: none;
  }
  
  .title {
    flex-grow: 1;
    text-align: center;
  }
  
  .navbtn{ 
    background: var(--panel); border:1px solid var(--stroke); padding:8px;
    border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink: 0;
  }
  .title{ font-weight:700; letter-spacing:.5px; padding:6px 10px; border-radius:10px; background:var(--panel); border:1px solid var(--stroke); }
  input[type="month"]{ background:transparent; color:var(--txt); border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px; outline:none; flex-shrink: 0; }
  .chip{ padding:6px 12px; border-radius:999px; background: var(--panel); border:1px solid var(--stroke); cursor:pointer; user-select:none; }
  
  .btn.chip { user-select: none; }

  /* 12hr/24hr 按鈕特定顏色 */
  #btnToggle12hr,
  #btnToggle24hr {
    transition: background-color 0.2s, color 0.2s, border-color 0.2s, opacity 0.2s;
    font-weight: 600;
    color: #ffffff; /* 文字統一白色 */
    outline: none; /* 移除點擊時嘅 blue outline */
    border: 1px solid var(--stroke);
  }

  #btnToggle12hr[data-on="1"],
  #btnToggle24hr[data-on="1"] {
    /* ON State (Green) */
    background-color: #22c55e;
    border-color: #22c55e;
    opacity: 1;
  }
  
  #btnToggle12hr[data-on="0"],
  #btnToggle24hr[data-on="0"] {
    /* OFF State (Red) */
    background-color: #e11d48;
    border-color: #e11d48;
    opacity: 0.85; /* 稍為調暗 */
  }
  
  #btnToggle12hr:hover,
  #btnToggle24hr:hover {
    opacity: 1; /* 確保 hover 時 100% */
    outline: none; 
  }
  
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--panel); color:var(--txt); cursor:pointer; }
  .btn:hover:not(#btnToggle12hr):not(#btnToggle24hr) { 
    outline:2px solid var(--accent); 
  }
  
  .weekbar{ display:grid; grid-template-columns: repeat(7,1fr); background: var(--weekbar); border-radius:10px; overflow:hidden; margin-top:10px; }
  .weekbar div{ text-align:center; padding:8px 0; font-size:12px; color:#e7eaf1; transition: color 0.2s; }
  .weekbar div.is-today {
    color: var(--today);
    font-weight: 700;
  }
  
  .grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:3px; margin-top:8px; }
  
  .cell{ 
    min-height: 110px; 
    background: var(--card); border:1px solid var(--stroke); border-radius:10px; 
    padding: 5px;
    display:flex; flex-direction:column; 
    gap: 3px;
    transition: opacity .2s, border-color .2s; cursor:pointer; 
  }
  .cell.dim{ opacity:.35; }
  
  .cell.filtered-dim { opacity: .35; }
  
  .dhead{ display:flex; align-items:center; justify-content:space-between; }
  .dnum{ font-weight:700; font-size: 15px; }
  .dnum.today{ outline:2px solid var(--today); border-radius:8px; padding:1px 5px; }

  .cell.is-holiday {
    border-left: 3px solid var(--holiday);
    padding-left: 6px;
  }
  .cell.is-marker {
    border-left-width: 3px;
    padding-left: 6px;
  }
  /* --- (v5.9) 漸變色邊框邏輯 --- */
  .cell.is-marker-blue { border-left-color: var(--marker-blue); }
  .cell.is-marker-green { border-left-color: var(--marker-green); }
  .cell.is-marker-split {
    border-image: linear-gradient(
      to bottom, 
      var(--marker-blue) 49%, 
      var(--stroke) 49%, 
      var(--stroke) 51%, 
      var(--marker-green) 51%
    ) 1;
  }
  /* 假期 + 標記 */
  .cell.is-holiday.is-marker-blue {
     border-image: linear-gradient(
      to bottom, 
      var(--holiday) 49%, 
      var(--stroke) 49%, 
      var(--stroke) 51%, 
      var(--marker-blue) 51%
    ) 1;
  }
  .cell.is-holiday.is-marker-green {
     border-image: linear-gradient(
      to bottom, 
      var(--holiday) 49%, 
      var(--stroke) 49%, 
      var(--stroke) 51%, 
      var(--marker-green) 51%
    ) 1;
  }
  .cell.is-holiday.is-marker-split {
     border-image: linear-gradient(
      to bottom, 
      var(--holiday) 32%, 
      var(--stroke) 32%, 
      var(--stroke) 34%, 
      var(--marker-blue) 34%,
      var(--marker-blue) 65%,
      var(--stroke) 65%, 
      var(--stroke) 67%, 
      var(--marker-green) 67%
    ) 1;
  }

  .trip-five, .trip-three {
    display: none;
    flex-direction: column;
    gap: 1px;
  }
  .grid.show-five-team .trip-five {
    display: flex;
  }
  .grid.show-three-team .trip-three {
    display: flex;
    border-top: 1px dashed var(--stroke);
    margin-top: 4px;
    padding-top: 4px;
  }
  
  .code{ font-weight:800; letter-spacing:0.1px; font-size: 12px; }
  
  .A{ color:#3b82f6;} 
  .B{ color:#f59e0b;} 
  .C{ color:#22c55e;} 
  .D{ color:#8b5cf6;} 
  .E{ color:#fb7185;}
  
  .notes-input{
    margin-top:auto;
    width:100%;
    background: var(--panel);
    border:1px solid var(--stroke);
    border-radius:6px;
    color: var(--txt);
    /* (v5.6 FIX) */
    padding:2px 6px;
    font-size:16px; 
    outline: none;
    cursor:text;
  }
  .notes-input::placeholder{ color: var(--muted); opacity: 0.6; }
  .notes-input:focus{ outline:1px solid var(--accent); }

  .modal-backdrop {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity .2s;
  }
  .modal-backdrop.show {
    opacity: 1; pointer-events: auto;
  }
  .modal-content {
    background: #1c2536;
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 20px;
    min-width: 300px;
    max-width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .modal-content p {
    text-align: center;
    margin-top: 0;
  }
  .modal-content button {
    margin-top: 15px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .modal-content h3 {
    margin-top: 0;
    text-align: left;
  }
  .modal-content ul {
    text-align: left;
    padding-left: 20px;
    color: var(--muted);
  }
  .modal-content li {
    margin-bottom: 10px;
    line-height: 1.5;
  }
  .modal-content code {
    background: var(--panel);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 15px;
    text-align: left;
  }
  .form-group label {
    font-size: 13px;
    color: var(--muted);
  }
  .form-group input, .form-group select {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    padding: 8px 10px;
    color: var(--txt);
    outline: none;
  }
  .form-group input:focus, .form-group select:focus {
    outline: 1px solid var(--accent);
  }
  
  /* (v5.13) Import Modal Textarea */
  #importDataText {
    width: 100%;
    min-height: 200px;
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    color: var(--txt);
    padding: 10px;
    font-size: 14px;
  }
  
  .radio-group-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  .radio-group-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }
  .radio-group-row label, .radio-group-grid label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .filter-options-group {
    border-top: 1px solid var(--stroke);
    margin-top: 15px;
    padding-top: 15px;
  }
  
  .color-select {
    display: flex;
    gap: 10px;
  }
  .color-select label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .color-dot {
    width: 16px; height: 16px;
    border-radius: 50%;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .modal-actions button.secondary {
    background: var(--panel);
    color: var(--txt);
  }
  
  /* --- (v5.4) 新增：markerInfoModal 列表樣式 --- */
  .marker-item { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    margin-bottom: 8px; 
    background: var(--panel);
    padding: 8px;
    border-radius: 6px;
  }
  .marker-item span { flex-grow: 1; font-size: 14px; }
  .marker-item .color-dot { flex-shrink: 0; }
  .marker-item button { 
      background: var(--holiday); 
      color: var(--txt); 
      padding: 4px 8px; 
      font-size: 12px; 
      margin: 0; 
      border-radius: 6px;
  }
  
  /* 動畫 */
  @keyframes bounce-in-right {
      0% { transform: translateX(100%); opacity: 0; }
      60% { transform: translateX(-10%); opacity: 1; }
      80% { transform: translateX(5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-left {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
  }
  @keyframes bounce-in-left {
      0% { transform: translateX(-100%); opacity: 0; }
      60% { transform: translateX(10%); opacity: 1; }
      80% { transform: translateX(-5%); }
      100% { transform: translateX(0%); }
  }
  @keyframes bounce-out-right {
      0% { transform: translateX(0%); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
  }

  .grid.animate-in-right { animation: bounce-in-right 0.4s ease-out forwards; }
  .grid.animate-out-left { animation: bounce-out-left 0.4s ease-out forwards; }
  .grid.animate-in-left { animation: bounce-in-left 0.4s ease-out forwards; }
  .grid.animate-out-right { animation: bounce-out-right 0.4s ease-out forwards; }
  
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top-controls">
      <button class="navbtn" id="prevM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </button>
      <div class="title" id="title"></div>
      <button class="navbtn" id="nextM">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>
      <input type="month" id="monthPick">
    </div>
    <div class="top-filters">
      
      <div class="button-group">
        <button class="btn chip" id="btnToggle12hr" data-on="1">12小時工作</button>
        <button class="btn chip" id="btnToggle24hr" data-on="0">24小時工作</button>
        <button class="btn" id="btnShowFilter" style="background: var(--panel);">篩選</button>
        <button class="btn btn-help" id="btnHelp">說明</button>
        <button class="btn btn-add-marker" id="btnAddMarker">+ 標記</button>
        <!-- (v5.13) 新增「匯入資料」按鈕 -->
        <button class="btn" id="btnImport">匯入資料</button>
        <button class="btn" id="btnExportText">輸出文字</button>
        <button class="btn" id="btnExport">輸出 CSV</button>
      </div>
    </div>
    <div class="weekbar" id="weekbar">
      <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
    </div>
  </div>
</header>

<main class="wrap" id="mainWrap">
  <div class="grid" id="grid"></div>
</main>

<!-- 彈窗 (提示) -->
<div class="modal-backdrop" id="customAlert">
  <div class="modal-content">
    <p id="customAlertMsg"></p>
    <button id="customAlertClose">明白</button>
  </div>
</div>

<!-- (v5.13) 新增「匯入資料」彈窗 -->
<div class="modal-backdrop" id="importModal">
  <div class="modal-content">
    <h3>匯入資料</h3>
    <p style="text-align: left; color: var(--muted); font-size: 14px; margin-bottom: 10px;">
      請貼上由「輸出文字」功能複製嘅內容。系統將會合併資料，並唔會覆蓋你現有嘅備註或標記。
    </p>
    <div class="form-group">
      <textarea id="importDataText" placeholder="貼上匯出嘅文字..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="secondary" id="btnCancelImport">取消</button>
      <button id="btnDoImport">匯入</button>
    </div>
  </div>
</div>

<!-- 彈窗 (新增標記) -->
<div class="modal-backdrop" id="markerModal">
  <div class="modal-content">
    <h3>新增自訂標記</h3>
    <div class="form-group">
      <label for="markerDate">日期</label>
      <input type="date" id="markerDate">
    </div>
    <div class="form-group">
      <label for="markerDesc">說明</label>
      <input type="text" id="markerDesc" placeholder="e.g. 覆診">
    </div>
    <div class="form-group">
      <label>顏色</label>
      <div class="color-select">
        <label>
          <input type="radio" name="markerColor" value="blue" checked>
          <span class="color-dot" style="background: var(--marker-blue);"></span> 藍色
        </label>
        <label>
          <input type="radio" name="markerColor" value="green">
          <span class="color-dot" style="background: var(--marker-green);"></span> 綠色
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="secondary" id="btnCancelMarker">取消</button>
      <button id="btnSaveMarker">儲存</button>
    </div>
  </div>
</div>

<!-- --- 彈窗 (顯示/刪除標記) --- -->
<div class="modal-backdrop" id="markerInfoModal">
  <div class="modal-content">
    <h3 style="display: flex; align-items: center; gap: 8px;">
      標記詳情
    </h3>
    <p id="markerInfoDate" style="font-size: 14px; color: var(--muted); text-align: left; margin: 0;"></p>
    
    <!-- (v5.4)  markerInfoList 用於動態建立列表 -->
    <div id="markerInfoList" class="form-group" style="margin-top: 15px;">
      <!-- Dynamic list will be built here -->
    </div>
    
    <div class="modal-actions">
      <button class="secondary" id="btnCloseMarkerInfo">關閉</button>
    </div>
  </div>
</div>

<!-- --- 新增：篩選 Modal --- -->
<div class="modal-backdrop" id="filterModal">
  <div class="modal-content">
    <h3>週期篩選</h3>
    
    <div class="form-group">
      <label>篩選類型</label>
      <div class="radio-group-row">
        <label><input type="radio" name="filterType" value="none" checked> 不篩選</label>
        <label><input type="radio" name="filterType" value="12hr"> 12小時</label>
        <label><input type="radio" name="filterType" value="24hr"> 24小時</label>
      </div>
    </div>

    <!-- 12-hour options -->
    <div class="filter-options-group" id="filterOptions12hr" style="display: none;">
      <div class="form-group">
        <label>12小時 - 字母</label>
        <div class="radio-group-grid">
          <label><input type="radio" name="filter12Letter" value="none" checked> 無</label>
          <label><input type="radio" name="filter12Letter" value="A"> A</label>
          <label><input type="radio" name="filter12Letter" value="B"> B</label>
          <label><input type="radio" name="filter12Letter" value="C"> C</label>
          <label><input type="radio" name="filter12Letter" value="D"> D</label>
          <label><input type="radio" name="filter12Letter" value="E"> E</label>
        </div>
      </div>
      <div class="form-group">
        <label>12小時 - 數字 (Rota)</label>
        <div class="radio-group-grid" style="grid-template-columns: repeat(6, 1fr);">
          <label><input type="radio" name="filter12Number" value="none" checked> 無</label>
          <label><input type="radio" name="filter12Number" value="1"> 1</label>
          <label><input type="radio" name="filter12Number" value="2"> 2</label>
          <label><input type="radio" name="filter12Number" value="3"> 3</label>
          <label><input type="radio" name="filter12Number" value="4"> 4</label>
          <label><input type="radio" name="filter12Number" value="5"> 5</label>
          <label><input type="radio" name="filter12Number" value="6"> 6</label>
          <label><input type="radio" name="filter12Number" value="7"> 7</label>
          <label><input type="radio" name="filter12Number" value="8"> 8</label>
          <label><input type="radio" name="filter12Number" value="9"> 9</label>
          <label><input type="radio" name="filter12Number" value="10"> 10</label>
        </div>
      </div>
    </div>

    <!-- 24-hour options -->
    <div class="filter-options-group" id="filterOptions24hr" style="display: none;">
      <div class="form-group">
        <label>24小時 - 字母</label>
        <div class="radio-group-grid">
          <label><input type="radio" name="filter24Letter" value="none" checked> 無</label>
          <label><input type="radio" name="filter24Letter" value="A"> A</label>
          <label><input type="radio" name="filter24Letter" value="B"> B</label>
          <label><input type="radio" name="filter24Letter" value="C"> C</label>
          <label><input type="radio" name="filter24Letter" value="D"> D</label>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="secondary" id="btnClearFilter">清除篩選</button>
      <button class="secondary" id="btnCancelFilter">取消</button>
      <button id="btnApplyFilter">套用篩選</button>
    </div>
  </div>
</div>


<!-- 彈窗 (幫助說明) -->
<div class="modal-backdrop" id="helpModal">
  <div class="modal-content">
    <h3>使用說明</h3>
    <!-- --- 說明文字 (已更新) --- -->
    <ul>
      <li><b>週期篩選</b>: 點擊 <code>篩選</code> 按鈕，可以彈出篩選視窗。您可以嚴格區分「12小時」或「24小時」工作類型進行篩選。</li>
      <li><b>12小時 / 24小時</b>: 點擊 <code>12小時工作</code> 或 <code>24小時工作</code> 按鈕，可切換顯示對應嘅班次排序。</li>
      <li><b>匯入/輸出</b>: 點擊 <code>輸出文字</code> 複製你嘅資料，其他人可以㩒 <code>匯入資料</code> 並貼上，系統會自動合併（唔會覆蓋）標記同備註。</li>
      <li><b>自動儲存</b>: 在日期格底部輸入的「備註」，將會自動儲存於您的瀏覽器中，下次開啟時資料將自動載入。</li>
      <li><b>公眾假期</b>: 左側帶有<code>紅色</code>邊框的日期為香港公眾假期，點擊該日期格可查看假期名稱。</li>
      <li><b>自訂標記</b>: 點擊 <code>+ 標記</code> 按鈕可新增標記。點擊已標記嘅日期格，可以查閱說明或 <code>刪除</code> 該標記。</li>
    </ul>
    <button id="btnCloseHelp">明白</button>
  </div>
</div>


<script>
// ---- 固定規則： (v5.12) 'TODAY_ISO' 改名為 'ANCHOR_ISO' ----
const LETTERS = ['A','B','C','D','E'];
const ANCHOR_ISO = '2025-11-09'; // 2025-11-09 = C6 (C6 嘅計算基準日)
const ANCHOR_LETTER = 'C';
const ANCHOR_NUMBER = 6;

// --- "24小時工作" (三隊制) 排序邏輯 ---
const ANCHOR_3_TEAM = '2025-11-09';
const CYCLE_24 = ['C(24)', 'A(24)', 'B(24)']; // 3-day cycle
const CYCLE_4D = ['C(2D)', 'D(2D)', 'A(2D)', 'B(2D)']; // 4-day cycle

// --- (v5.12) 新增：獲取真實 "今日" 日期 (HKT) ---
function getTodayISO() {
    const today = new Date();
    // Format to YYYY-MM-DD in Asia/Hong_Kong timezone
    const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Hong_Kong' };
    try {
        const parts = new Intl.DateTimeFormat('en-CA', options).formatToParts(today);
        const y = parts.find(p => p.type === 'year').value;
        const m = parts.find(p => p.type === 'month').value;
        const d = parts.find(p => p.type === 'day').value;
        return `${y}-${m}-${d}`;
    } catch (e) {
        console.error("Failed to get HKT date, falling back to local.", e);
        // Fallback for environments that don't support en-CA or timeZone
        const y = today.getFullYear();
        const m = (today.getMonth() + 1).toString().padStart(2, '0');
        const d = today.getDate().toString().padStart(2, '0');
        return `${y}-${m}-${d}`;
    }
}
const ACTUAL_TODAY_ISO = getTodayISO();


// --- 內置假期資料庫 (2024-2026) ---
const HOLIDAY_DATA = {
    "2024": {
        "2024-01-01": "元旦", "2024-02-10": "農曆年初一", "2024-02-12": "農曆年初三", "2024-02-13": "農曆年初四", "2024-03-29": "耶穌受難節", "2024-03-30": "耶穌受難節翌日", "2024-04-01": "復活節星期一", "2024-04-04": "清明節", "2024-05-01": "勞動節", "2024-05-15": "佛誕", "2024-06-10": "端午節", "2024-07-01": "香港特別行政區成立紀念日", "2024-09-18": "中秋節翌日", "2024-10-01": "國慶日", "2024-10-11": "重陽節", "2024-12-25": "聖誕節", "2024-12-26": "聖誕節後第一個周日"
    },
    "2025": {
        "2025-01-01": "元旦", "2025-01-29": "農曆年初一", "2025-01-30": "農曆年初二", "2025-01-31": "農曆年初三", "2025-04-18": "耶穌受難節", "2025-04-19": "耶穌受難節翌日", "2025-04-21": "復活節星期一", "2025-04-04": "清明節", "2025-05-01": "勞動節", "2025-05-05": "佛誕", 
        /* (v5.11 FIX) 移除 v5.9/v5.10 引入嘅 "2CH-J" 語法錯誤 */ 
        "2025-05-31": "端午節", "2025-07-01": "香港特別行政區成立紀念日", "2025-10-01": "國慶日", "2025-10-07": "中秋節翌日", "2025-10-30": "重陽節", "2025-12-25": "聖誕節", "2025-12-26": "聖誕節後第一個周日"
    },
    "2026": {
        "2026-01-01": "元旦", "2026-02-17": "農曆年初一", "2026-02-18": "農曆年初二", "2026-02-19": "農曆年初三", "2026-04-03": "耶穌受難節", "2026-04-04": "耶穌受難節翌日", "2026-04-06": "復活節星期一", "2026-04-04": "清明節", "2026-05-01": "勞動節", "2026-05-25": "佛誕", "2026-06-19": "端午節", "2026-07-01": "香港特別行政區成立紀念日", "2026-09-26": "中秋節翌日", "2026-10-01": "國慶日", "2026-10-02": "國慶日翌日", "2026-10-19": "重陽節", "2026-12-25": "聖誕節"
    }
};

// ---- Global 數據儲存 ----
let dailyNotes = {}; 
let customMarkers = {};
let holidaysCache = new Map(); 

// --- Global 顯示狀態 (已更新預設值) ---
let showFiveTeam = true;  // 12小時工作 (預設 ON)
let showThreeTeam = false; // 24小時工作 (預設 OFF)
let currentMarkerISO = null; // 用於追蹤要刪除嘅標記

// --- 新增：Global 篩選狀態 ---
let filterState = {
    type: 'none', // 'none', '12hr', '24hr'
    letter12: 'none',
    number12: 'none',
    letter24: 'none'
};

// ---- 儲存/讀取功能 (LocalStorage) ----
function saveData() {
    try {
        localStorage.setItem('calendarNotes', JSON.stringify(dailyNotes));
        localStorage.setItem('calendarMarkers', JSON.stringify(customMarkers));
    } catch (e) {
        console.error('Failed to save data', e);
        showModal('儲存資料時發生錯誤，空間可能已滿。');
    }
}
function loadData() {
    const notes = localStorage.getItem('calendarNotes');
    const markers = localStorage.getItem('calendarMarkers');
    try {
      if (notes) { dailyNotes = JSON.parse(notes) || {}; }
      if (markers) { 
          customMarkers = JSON.parse(markers) || {}; 
          
          // --- (v5.4) 遷移邏輯：將舊嘅 "單一物件" 轉為 "陣列" ---
          Object.keys(customMarkers).forEach(iso => {
              if (customMarkers[iso] && !Array.isArray(customMarkers[iso])) {
                  // 舊資料 (單一物件)
                  if (!customMarkers[iso].id) {
                      customMarkers[iso].id = Date.now() + '-' + Math.random(); // (FIX) 統一 ID 格式
                  }
                  customMarkers[iso] = [customMarkers[iso]]; // 轉為陣列
              } else if (customMarkers[iso] && Array.isArray(customMarkers[iso])) {
                  // 新資料 (陣列)，確保所有項目都有 ID
                  customMarkers[iso].forEach(marker => {
                      if (!marker.id) {
                          marker.id = Date.now() + '-' + Math.random(); // (FIX) 統一 ID 格式
                      }
                  });
              }
          });
          // --- (v5.4) 遷移結束 ---
      }
    } catch (e) {
      console.error('Failed to parse saved data', e);
      dailyNotes = {}; customMarkers = {};
    }
}

// ---- 工具函數 ----
function fmtISO(d){
  const y = d.getFullYear();
  const m = (d.getMonth() + 1).toString().padStart(2, '0');
  const day = d.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function daysBetween(aISO,bISO){ return Math.round((new Date(bISO)-new Date(aISO))/86400000); }
function mod(a,b){ return ((a % b)+b)%b; }

// --- 計算主更 "12小時" (e.g. C6) ---
function letterNumFor(dateISO){
  const i0 = LETTERS.indexOf(ANCHOR_LETTER);
  const n = daysBetween(ANCHOR_ISO, dateISO); // (v5.12) 使用 ANCHOR_ISO
  const idx = mod(i0 - n, 5);
  const wraps = Math.floor((i0 + n)/5);
  let num = ANCHOR_NUMBER + wraps;
  num = ((num - 1) % 10 + 10) % 10 + 1;
  return {letter: LETTERS[idx], number: num};
}

// --- "12小時" 排序邏輯 [Anchor(date), Anchor(date-1), Anchor(date-2)] ---
function triplet(dateISO){
  const d = new Date(dateISO + 'T00:00:00');
  
  const {letter, number} = letterNumFor(dateISO);
  const t1 = `${letter}${number}`;
  
  d.setDate(d.getDate() - 1);
  const iso_d1 = fmtISO(d);
  const {letter: l_d1, number: n_d1} = letterNumFor(iso_d1);
  const t2 = `${l_d1}${n_d1}`;
  
  d.setDate(d.getDate() - 1);
  const iso_d2 = fmtISO(d);
  const {letter: l_d2, number: n_d2} = letterNumFor(iso_d2);
  const t3 = `${l_d2}${n_d2}`;
  
  return [t1, t2, t3];
}

// --- "24小時" (三隊制) 排序邏輯 (已更新) ---
function tripletThreeTeam(dateISO) {
  const n = daysBetween(ANCHOR_3_TEAM, dateISO);
  
  const shift1 = CYCLE_24[mod(n, 3)];
  const shift2 = CYCLE_4D[mod(n, 4)];
  const shift3 = CYCLE_4D[mod(n - 1, 4)];
  
  return [shift1, shift2, shift3];
}


// 計算月曆第一格 (可能係上個月) 嘅日期
function firstCellDate(y, m){
  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  return new Date(y, m, 1 - startDow);
}

// ---- Modal 顯示/隱藏 ----
function showModal(message) {
  const modal = document.getElementById('customAlert');
  const msg = document.getElementById('customAlertMsg');
  msg.textContent = message;
  modal.classList.add('show');
}
function closeModal() {
  const modal = document.getElementById('customAlert');
  modal.classList.remove('show');
}
function showMarkerModal(dateISO = '') {
    document.getElementById('markerDate').value = dateISO || fmtISO(new Date());
    document.getElementById('markerDesc').value = '';
    document.querySelector('input[name="markerColor"][value="blue"]').checked = true;
    document.getElementById('markerModal').classList.add('show');
}
function closeMarkerModal() {
    document.getElementById('markerModal').classList.remove('show');
}
function showHelpModal() {
    document.getElementById('helpModal').classList.add('show');
}
function closeHelpModal() {
    document.getElementById('helpModal').classList.remove('show');
}

// --- (v5.13) Import Modal ---
function showImportModal() {
    document.getElementById('importDataText').value = ''; // 清空
    document.getElementById('importModal').classList.add('show');
}
function closeImportModal() {
    document.getElementById('importModal').classList.remove('show');
}

// --- 新增：篩選 Modal 顯示/隱藏 ---
function showFilterModal() {
    // 載入 modal 時，將 global state 填入 radio buttons
    document.querySelector(`input[name="filterType"][value="${filterState.type}"]`).checked = true;
    document.querySelector(`input[name="filter12Letter"][value="${filterState.letter12}"]`).checked = true;
    document.querySelector(`input[name="filter12Number"][value="${filterState.number12}"]`).checked = true;
    document.querySelector(`input[name="filter24Letter"][value="${filterState.letter24}"]`).checked = true;
    
    // 根據 filterType 顯示/隱藏選項
    document.getElementById('filterOptions12hr').style.display = (filterState.type === '12hr') ? 'block' : 'none';
    document.getElementById('filterOptions24hr').style.display = (filterState.type === '24hr') ? 'block' : 'none';
    
    document.getElementById('filterModal').classList.add('show');
}
function closeFilterModal() {
    document.getElementById('filterModal').classList.remove('show');
}


// --- (v5.8) 顯示/刪除 標記 Modal (已重寫) ---
function showMarkerInfoModal(iso, markers) {
    currentMarkerISO = iso; // 儲存 iso
    const modal = document.getElementById('markerInfoModal');
    const listDiv = document.getElementById('markerInfoList');
    document.getElementById('markerInfoDate').textContent = iso;
    listDiv.innerHTML = ''; // 清空舊列表

    // (v5.8) 自動檢查並顯示假期
    const d = new Date(iso + 'T00:00:00');
    const year = d.getFullYear();
    const holidayMap = getHolidayMapForYear(year);
    const holidayName = holidayMap.get(iso) || '';
    
    if (holidayName) {
        listDiv.innerHTML += `
            <div class="marker-item" style="background: #a11a3a; color: white; font-weight: 600;">
                <span class="color-dot" style="background: var(--holiday);"></span>
                <span>${holidayName}</span>
                <!-- 假期冇刪除掣 -->
            </div>
        `;
    }

    if (!markers || markers.length === 0) {
        if (!holidayName) { // 只有喺連假期都冇嘅情況下先顯示 "沒有標記"
             listDiv.innerHTML += '<p style="text-align: left; color: var(--muted); margin: 0;">此日期沒有標記。</p>';
        }
    } else {
        markers.forEach((marker) => {
            const item = document.createElement('div');
            item.className = 'marker-item';
            // 確保 description 係 HTML-safe (e.g. 處理 <>)
            const descText = document.createTextNode(marker.description);
            const descSpan = document.createElement('span');
            descSpan.appendChild(descText);
            
            item.innerHTML = `
                <span class="color-dot" style="background: var(--marker-${marker.color});"></span>
                <span>${descSpan.innerHTML}</span>
                <button class="btn-delete-marker-item" data-id="${marker.id}">刪除</button>
            `;
            listDiv.appendChild(item);
        });
    }
    
    // 為新建立嘅 "刪除" 按鈕綁定事件
    listDiv.querySelectorAll('.btn-delete-marker-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
            // (v5.9 FIX) 移除 isAnimating guard
            // if (isAnimating) return; 
            const idToDelete = e.target.dataset.id;
            
            // 1. 喺陣列中移除該 ID
            customMarkers[currentMarkerISO] = customMarkers[currentMarkerISO].filter(m => m.id !== idToDelete); 
            
            // 2. 如果陣列為空，刪除呢一日嘅 key
            if (customMarkers[currentMarkerISO] && customMarkers[currentMarkerISO].length === 0) {
                delete customMarkers[currentMarkerISO];
            }
            
            // 3. 儲存
            saveData();
            
            // 4. 重新整理 Modal 列表 (遞歸)
            showMarkerInfoModal(currentMarkerISO, customMarkers[currentMarkerISO]); // Refresh list
            
            // 5. 重新整理月曆 (更新邊框)
            const [y, m] = monthPick.value.split('-').map(Number);
            render(currentGrid, y, m - 1);
        });
    });
    
    modal.classList.add('show');
}
function closeMarkerInfoModal() {
    currentMarkerISO = null;
    document.getElementById('markerInfoModal').classList.remove('show');
}


// --- 複製文字到剪貼簿 ---
function copyToClipboard(text) {
    const ta = document.createElement('textarea');
    ta.style.position = 'absolute';
    ta.style.left = '-9999px';
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try {
        document.execCommand('copy');
        showModal('已複製到剪貼簿！');
    } catch (err) {
        console.error('Failed to copy text: ', err);
        showModal('複製失敗，請重試。');
    }
    document.body.removeChild(ta);
}

// --- 獲取該年份嘅假期 (使用內置資料) ---
function getHolidayMapForYear(year) {
    const yearStr = String(year);
    if (holidaysCache.has(yearStr)) {
        return holidaysCache.get(yearStr);
    }
    if (HOLIDAY_DATA[yearStr]) {
        const holidayMap = new Map(Object.entries(HOLIDAY_DATA[yearStr]));
        holidaysCache.set(yearStr, holidayMap);
        return holidayMap;
    } else {
        return new Map();
    }
}


// ---- (v5.13) 新增：解析匯入嘅文字 ----
function parseImportedText(text) {
    const parsedMarkers = {};
    const parsedNotes = {};
    let currentISO = null;
    
    const lines = text.split('\n');
    const dateRegex = /^(\d{4}-\d{2}-\d{2})/; // 搵 YYYY-MM-DD
    // (v5.14 FIX) 放寬 Regex 規則，允許 '標記:' 同 '備註:' 後面有 0 或多個空格
    const markerRegex = /^- 標記: *(.*) \((藍色|綠色)\)$/;
    const noteRegex = /^- 備註: *(.*)$/;

    for (const line of lines) {
        const dateMatch = line.match(dateRegex);
        if (dateMatch) {
            currentISO = dateMatch[1];
            continue;
        }

        if (!currentISO) continue; // 未搵到日期之前，skip 晒

        const trimmedLine = line.trim();
        
        const markerMatch = trimmedLine.match(markerRegex);
        if (markerMatch) {
            if (!parsedMarkers[currentISO]) parsedMarkers[currentISO] = [];
            const desc = markerMatch[1];
            const color = (markerMatch[2] === '藍色') ? 'blue' : 'green';
            parsedMarkers[currentISO].push({
                description: desc,
                color: color,
                id: Date.now() + '-' + Math.random()
            });
            continue;
        }

        const noteMatch = trimmedLine.match(noteRegex);
        if (noteMatch) {
            parsedNotes[currentISO] = noteMatch[1];
            continue;
        }
    }
    return { parsedMarkers, parsedNotes };
}

// ---- (v5.13) 新增：合併匯入嘅資料 ----
function mergeData(parsedMarkers, parsedNotes) {
    let markersAdded = 0;
    let notesAdded = 0;

    // 1. 合併 Notes
    for (const iso in parsedNotes) {
        if (Object.prototype.hasOwnProperty.call(parsedNotes, iso)) {
            const newNote = parsedNotes[iso];
            if (dailyNotes[iso] && dailyNotes[iso] !== newNote) {
                // 已有唔同嘅 note，合併
                dailyNotes[iso] = dailyNotes[iso] + " / " + newNote;
                notesAdded++;
            } else if (!dailyNotes[iso]) {
                // 冇 note，新增
                dailyNotes[iso] = newNote;
                notesAdded++;
            }
            // 如果 note 一樣，就唔使理
        }
    }

    // 2. 合併 Markers (防重複)
    for (const iso in parsedMarkers) {
        if (Object.prototype.hasOwnProperty.call(parsedMarkers, iso)) {
            if (!customMarkers[iso]) {
                customMarkers[iso] = []; // 確保係陣列
            }
            
            const newMarkers = parsedMarkers[iso];
            for (const newMark of newMarkers) {
                // 檢查係咪已存在 (相同 description + color)
                const exists = customMarkers[iso].some(oldMark => 
                    oldMark.description === newMark.description && 
                    oldMark.color === newMark.color
                );
                
                if (!exists) {
                    customMarkers[iso].push(newMark);
                    markersAdded++;
                }
            }
        }
    }
    
    return { markersAdded, notesAdded };
}


// ---- 核心 Render 函數 (繪製月曆) ----
function render(targetGrid, y, m_idx){
  const title = document.getElementById('title');
  targetGrid.innerHTML = '';
  if (isNaN(y) || isNaN(m_idx)) { return; }
  
  targetGrid.dataset.year = y;
  targetGrid.dataset.monthIndex = m_idx;
  
  title.textContent = new Date(y, m_idx, 1).toLocaleString('zh-HK',{year:'numeric', month:'long'});
  
  targetGrid.classList.toggle('show-five-team', showFiveTeam);
  targetGrid.classList.toggle('show-three-team', showThreeTeam);
  
  const yearHolidayMap = getHolidayMapForYear(y);
  const base = firstCellDate(y, m_idx);
  
  for(let i=0;i<42;i++){
    const d = new Date(base); d.setDate(base.getDate()+i);
    const iso = fmtISO(d); 
    const inMonth = d.getMonth()===m_idx;
    
    // --- 計算兩種排序 ---
    const tripFive = triplet(iso); // [C7, B7, A7]
    const tripThree = tripletThreeTeam(iso); // [C(24), C(2D), B(2D)]
    
    const holiday = yearHolidayMap.get(iso) || ''; 
    const markers = customMarkers[iso] || []; // (v5.4) 改為陣列

    const cell = document.createElement('div');
    cell.className = 'cell' + (inMonth ? '' : ' dim');
    cell.dataset.iso = iso; 
    
    // --- (v5.8) 點擊邏輯重構 ---
    if (holiday || markers.length > 0) {
        cell.addEventListener('click', () => {
            // (FIX v5.8) 移除 isAnimating guard
            
            // 優先級: 
            // 1. 如果有 markers (無論有冇假期)，顯示 marker modal (v5.8 嘅 modal 會同時顯示假期)
            // 2. 如果 *只有* 假期，顯示簡單 holiday modal
            
            if (markers.length > 0 || holiday) { // (v5.9) 只要有 marker *或* holiday，都用新 modal
                showMarkerInfoModal(iso, markers);
            }
            // (v5.9) 舊嘅 showModal(holiday) 邏輯已合併入 showMarkerInfoModal
        });
    }
    
    // (v5.9) 視覺 (Class) 邏輯分離
    if (holiday) {
        cell.classList.add('is-holiday');
    }
    if (markers.length > 0) {
        cell.classList.add('is-marker');
        const colors = new Set(markers.map(m => m.color));
        
        if (colors.has('blue') && colors.has('green')) {
            cell.classList.add('is-marker-split');
        } else if (colors.has('blue')) {
            cell.classList.add('is-marker-blue');
        } else if (colors.has('green')) {
            cell.classList.add('is-marker-green');
        }
    }
    // --- (v5.9) 點擊邏輯結束 ---
    
    // --- 篩選邏輯 (v5.3 修正) ---
    let isFiltered = false;
    if (inMonth && filterState.type !== 'none') {
        
        if (filterState.type === '12hr') {
            // "12小時" 篩選邏輯
            let dayMatches = false;
            
            if (filterState.letter12 === 'none' && filterState.number12 === 'none') {
                dayMatches = true; // 唔應該發生，因為 type 唔係 'none'
            } else if (filterState.letter12 !== 'none' && filterState.number12 === 'none') {
                // 只篩選字母 (e.g., C)
                dayMatches = tripFive.some(shift => shift[0] === filterState.letter12);
            } else if (filterState.letter12 === 'none' && filterState.number12 !== 'none') {
                // 只篩選數字 (e.g., 7)
                dayMatches = tripFive.some(shift => {
                    const numStr = (shift.match(/\d+/) || [''])[0];
                    return numStr === filterState.number12;
                });
            } else {
                // 篩選 字母 AND 數字 (e.g., C7)
                dayMatches = tripFive.some(shift => {
                    const letter = shift[0];
                    const numStr = (shift.match(/\d+/) || [''])[0];
                    return letter === filterState.letter12 && numStr === filterState.number12;
                });
            }

            if (!dayMatches) {
                isFiltered = true;
            }
            
        } else if (filterState.type === '24hr') {
            // "24小時" 篩選邏輯
            if (filterState.letter24 !== 'none') {
                const allLetters24 = tripThree.map(code => code[0]); // [C, C, B]
                const hasMatch = allLetters24.some(l => l === filterState.letter24);
                if (!hasMatch) {
                    isFiltered = true;
                }
            }
        }
    }
    
    if (isFiltered) {
        cell.classList.add('filtered-dim');
    }
    // --- (篩選邏輯結束) ---

    const head = document.createElement('div'); head.className='dhead';
    // (v5.12) 修正高光
    const num = document.createElement('div'); num.className='dnum' + (iso === ACTUAL_TODAY_ISO ? ' today' : '');
    num.textContent = d.getDate();
    head.appendChild(num);
    head.appendChild(document.createElement('div'));
    cell.appendChild(head);

    if(inMonth){
      const tp5 = document.createElement('div'); 
      tp5.className = 'trip-five';
      tripFive.forEach(code=>{ 
        const div=document.createElement('div'); 
        div.className='code';
        const letterForColor = code[0];
        div.classList.add(letterForColor);
        div.textContent=code; 
        tp5.appendChild(div); 
      });
      cell.appendChild(tp5);
      
      const tp3 = document.createElement('div'); 
      tp3.className = 'trip-three';
      tripThree.forEach(code=>{ 
        const div=document.createElement('div'); 
        div.className='code';
        const letterForColor = code[0];
        div.classList.add(letterForColor);
        div.textContent=code; 
        tp3.appendChild(div); 
      });
      cell.appendChild(tp3);
      
      const notes = document.createElement('input');
      notes.type = 'text';
      notes.className = 'notes-input';
      notes.placeholder = '加備註...';
      notes.value = dailyNotes[iso] || '';
      notes.addEventListener('input', (e) => {
        dailyNotes[iso] = e.target.value.trim();
        if (dailyNotes[iso] === '') delete dailyNotes[iso];
        saveData();
      });
      notes.addEventListener('click', (e) => { e.stopPropagation(); });
      cell.appendChild(notes);
    }
    targetGrid.appendChild(cell);
  }
}

// --- (v5.4) 收集數據 (簡化輸出) ---
function collectRows(isoDates){
  const rows = [];
  for(const iso of isoDates){
    const markers = customMarkers[iso] || [];
    // 將多個標記用分號組合
    const markerText = markers.map(m => m.description).join('; ');
    rows.push({
      iso,
      markers: markerText,
      note: dailyNotes[iso] || ''
    });
  }
  return rows;
}

// --- (v5.4) 輸出 CSV 功能 (簡化) ---
function exportCSV(rows){
  const header = ['日期', '標記', '備註']; // 簡化 header
  const lines = [header.join(',')];
  for(const r of rows){
    const cells = [ 
      r.iso, 
      r.markers || '', 
      r.note || '' 
    ].map(v => String(v).replaceAll('"','""'));
    lines.push(cells.map(v => /[",\n]/.test(v) ? `"${v}"` : v).join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='calendar_notes_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}

// ---- 主要執行：等 DOM Ready ----
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  
  const mainWrap = document.getElementById('mainWrap');
  const monthPick = document.getElementById('monthPick');
  const prevM = document.getElementById('prevM');
  const nextM = document.getElementById('nextM');
  const btnExport = document.getElementById('btnExport');
  const modalCloseBtn = document.getElementById('customAlertClose');
  const modalBackdrop = document.getElementById('customAlert');
  
  const btnAddMarker = document.getElementById('btnAddMarker');
  const markerModal = document.getElementById('markerModal');
  const btnCancelMarker = document.getElementById('btnCancelMarker');
  const btnSaveMarker = document.getElementById('btnSaveMarker');
  
  const btnHelp = document.getElementById('btnHelp');
  const helpModal = document.getElementById('helpModal');
  const btnCloseHelp = document.getElementById('btnCloseHelp');
  const btnExportText = document.getElementById('btnExportText');
  
  const btnToggle12hr = document.getElementById('btnToggle12hr');
  const btnToggle24hr = document.getElementById('btnToggle24hr');
  const markerInfoModal = document.getElementById('markerInfoModal');
  const btnCloseMarkerInfo = document.getElementById('btnCloseMarkerInfo');

  // --- 獲取篩選 Modal 元素 ---
  const btnShowFilter = document.getElementById('btnShowFilter');
  const filterModal = document.getElementById('filterModal');
  const btnApplyFilter = document.getElementById('btnApplyFilter');
  const btnClearFilter = document.getElementById('btnClearFilter');
  const btnCancelFilter = document.getElementById('btnCancelFilter');
  const filterTypeRadios = document.querySelectorAll('input[name="filterType"]');
  const filterOptions12hr = document.getElementById('filterOptions12hr');
  const filterOptions24hr = document.getElementById('filterOptions24hr');

  // --- (v5.13) 獲取匯入 Modal 元素 ---
  const btnImport = document.getElementById('btnImport');
  const importModal = document.getElementById('importModal');
  const btnCancelImport = document.getElementById('btnCancelImport');
  const btnDoImport = document.getElementById('btnDoImport');
  const importDataText = document.getElementById('importDataText');


  let currentGrid = document.getElementById('grid');
  let isAnimating = false; // (保留) 按鈕仍然需要
  
  mainWrap.style.position = 'relative';
  mainWrap.style.overflowX = 'hidden';

  if (!currentGrid || !btnToggle12hr || !btnToggle24hr || !markerInfoModal || !btnShowFilter || !btnImport) {
      console.error('Initialization failed: Missing critical DOM elements.');
      return;
  }
  
  btnToggle12hr.dataset.on = showFiveTeam ? '1' : '0';
  btnToggle24hr.dataset.on = showThreeTeam ? '1' : '0';

  // (v5.12) 修正：使用真實日期 (new Date()) 嚟設定初始畫面
  const t_today = new Date(); 
  const startYear = t_today.getFullYear();
  const startMonthIndex = t_today.getMonth();
  monthPick.value = `${startYear}-${(startMonthIndex + 1).toString().padStart(2, '0')}`;
  
  // (v5.12) 修正：使用真實日期嚟高光 "星期"
  const todayDow = t_today.getDay();
  const weekbarDivs = document.querySelectorAll('#weekbar div');
  if (weekbarDivs[todayDow]) {
      weekbarDivs[todayDow].classList.add('is-today');
  }

  // --- 切換月份核心函數 (帶動畫) ---
  function changeMonth(direction) {
      if (isAnimating) return;
      isAnimating = true;

      const [y, m] = monthPick.value.split('-').map(Number);
      const d = new Date(y, m - 1, 1);
      d.setMonth(d.getMonth() + direction);
      
      const newY = d.getFullYear();
      const newM_idx = d.getMonth();
      
      monthPick.value = `${newY}-${(newM_idx + 1).toString().padStart(2, '0')}`;

      const newGrid = document.createElement('div');
      newGrid.className = 'grid'; newGrid.id = 'grid';

      render(newGrid, newY, newM_idx); 
      
      const oldGrid = currentGrid;
      oldGrid.id = 'grid-old';
      
      mainWrap.appendChild(newGrid);
      currentGrid = newGrid;
      
      let animationEnded = false;
      const onAnimEnd = () => {
          if (animationEnded) return;
          animationEnded = true;
          if (document.body.contains(oldGrid)) {
            oldGrid.remove();
          }
          isAnimating = false;
      };
      
      oldGrid.addEventListener('animationend', onAnimEnd);
      setTimeout(onAnimEnd, 450); // Fallback

      requestAnimationFrame(() => {
          if (direction > 0) {
              oldGrid.classList.add('animate-out-left');
              newGrid.classList.add('animate-in-right');
          } else {
              oldGrid.classList.add('animate-out-right');
              newGrid.classList.add('animate-in-left');
          }
      });
  }
  
  // --- 綁定事件 ---
  prevM.addEventListener('click', () => changeMonth(-1));
  nextM.addEventListener('click', () => changeMonth(1));
  
  monthPick.addEventListener('change', () => {
      if (isAnimating) {
          if (currentGrid.dataset.year && currentGrid.dataset.monthIndex) {
              const y_s = currentGrid.dataset.year;
              const m_idx_s = currentGrid.dataset.monthIndex;
              monthPick.value = `${y_s}-${(parseInt(m_idx_s, 10) + 1).toString().padStart(2, '0')}`;
          }
          return; 
      }
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  // 輸出 CSV
  btnExport.addEventListener('click', ()=>{
    if (isAnimating) return;
    const isoDatesWithNotes = Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== '');
    if(isoDatesWithNotes.length === 0 && Object.keys(customMarkers).length === 0){ 
      showModal('請先輸入至少一項備註或標記。');
      return; 
    }
    const allDates = new Set([...Object.keys(dailyNotes), ...Object.keys(customMarkers)]);
    const sortedDates = Array.from(allDates).sort();
    
    const rows = collectRows(sortedDates);
    exportCSV(rows);
  });

  // 提示 Modal
  modalCloseBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  
  // 新增標記 Modal
  btnAddMarker.addEventListener('click', () => { 
    if (isAnimating) return;
    showMarkerModal(); 
  });
  btnCancelMarker.addEventListener('click', closeMarkerModal);
  markerModal.addEventListener('click', (e) => {
    if (e.target === markerModal) closeMarkerModal();
  });
  btnSaveMarker.addEventListener('click', () => {
      const date = document.getElementById('markerDate').value;
      const desc = document.getElementById('markerDesc').value;
      const color = document.querySelector('input[name="markerColor"]:checked').value;
      
      if (!date || !desc) {
          showModal('請填寫日期和說明。');
          return;
      }
      
      // --- (v5.4) 寫入邏輯更新 ---
      if (!customMarkers[date]) {
          customMarkers[date] = []; // 確保係陣列
      }
      customMarkers[date].push({ 
          description: desc, 
          color: color, 
          id: Date.now() + '-' + Math.random() // 加入 unique ID
      });
      // --- (v5.4) 結束 ---
      
      saveData();
      closeMarkerModal();
      
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });
  
  // 幫助 Modal
  btnHelp.addEventListener('click', () => {
    if (isAnimating) return;
    showHelpModal();
  });
  btnCloseHelp.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) closeHelpModal();
  });
  
  // --- 12/24小時 切換事件 ---
  btnToggle12hr.addEventListener('click', () => {
      if (isAnimating) return;
      showFiveTeam = !showFiveTeam;
      btnToggle12hr.dataset.on = showFiveTeam ? '1' : '0';
      
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  btnToggle24hr.addEventListener('click', () => {
      if (isAnimating) return;
      showThreeTeam = !showThreeTeam;
      btnToggle24hr.dataset.on = showThreeTeam ? '1' : '0';

      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });

  // --- 刪除標記 Modal 事件 ---
  btnCloseMarkerInfo.addEventListener('click', closeMarkerInfoModal);
  markerInfoModal.addEventListener('click', (e) => {
      if (e.target === markerInfoModal) closeMarkerInfoModal();
  });
  
  // --- 新增：篩選 Modal 事件 ---
  btnShowFilter.addEventListener('click', () => {
      if (isAnimating) return;
      showFilterModal();
  });

  filterTypeRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
          // --- (FIX v5.3) 修正 'e.g.target' 錯誤 ---
          filterOptions12hr.style.display = (e.target.value === '12hr') ? 'block' : 'none';
          filterOptions24hr.style.display = (e.target.value === '24hr') ? 'block' : 'none';
      });
  });

  btnCancelFilter.addEventListener('click', closeFilterModal);
  filterModal.addEventListener('click', (e) => {
      if (e.target === filterModal) closeFilterModal();
  });

  btnClearFilter.addEventListener('click', () => {
      filterState = { type: 'none', letter12: 'none', number12: 'none', letter24: 'none' };
      closeFilterModal();
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });
  
  btnApplyFilter.addEventListener('click', () => {
      filterState.type = document.querySelector('input[name="filterType"]:checked').value;
      filterState.letter12 = document.querySelector('input[name="filter12Letter"]:checked').value;
      filterState.number12 = document.querySelector('input[name="filter12Number"]:checked').value;
      filterState.letter24 = document.querySelector('input[name="filter24Letter"]:checked').value;
      
      closeFilterModal();
      const [y, m] = monthPick.value.split('-').map(Number);
      render(currentGrid, y, m - 1);
  });


  // --- (v5.4) 輸出文字 (簡化) ---
  btnExportText.addEventListener('click', () => {
      if (isAnimating) return;
      const allIsoDates = new Set([
          ...Object.keys(dailyNotes).filter(iso => dailyNotes[iso] && dailyNotes[iso].trim() !== ''), 
          ...Object.keys(customMarkers)
      ]);
      
      const sortedDates = Array.from(allIsoDates).sort();
      
      if (sortedDates.length === 0) {
          showModal('沒有任何備註或標記可供複製。');
          return;
      }

      let output = "📅 你的日曆匯出\n--------------------\n\n";
      
      for (const iso of sortedDates) {
          const d = new Date(iso + 'T00:00:00');
          const weekday = d.toLocaleDateString('zh-HK', { weekday: 'short' });
          const note = dailyNotes[iso];
          const markers = customMarkers[iso] || []; // (v5.4) 讀取陣列
          
          const year = d.getFullYear();
          const holidayMap = getHolidayMapForYear(year);
          const holiday = holidayMap.get(iso);

          output += `${iso} (${weekday})\n`;
          
          if (holiday) {
              output += `  - 假期: ${holiday}\n`;
          }
          
          // (v5.4) 循環輸出所有標記
          markers.forEach(marker => {
              const colorName = marker.color === 'blue' ? '藍色' : '綠色';
              output += `  - 標記: ${marker.description} (${colorName})\n`;
          });
          
          if (note && note.trim() !== '') {
              output += `  - 備註: ${note}\n`;
          }
          
          output += '\n';
      }
      
      output += "--------------------";
      copyToClipboard(output);
  });
  
  // --- (v5.13) 匯入資料 事件 ---
  btnImport.addEventListener('click', () => {
      if (isAnimating) return;
      showImportModal();
  });
  btnCancelImport.addEventListener('click', closeImportModal);
  importModal.addEventListener('click', (e) => {
      if (e.target === importModal) closeImportModal();
  });
  btnDoImport.addEventListener('click', () => {
      const text = importDataText.value;
      if (!text || text.trim() === '') {
          showModal("請先貼上文字。");
          return;
      }
      
      try {
          const { parsedMarkers, parsedNotes } = parseImportedText(text);
          const { markersAdded, notesAdded } = mergeData(parsedMarkers, parsedNotes);
          
          saveData();
          closeImportModal();
          
          // 重新整理
          const [y, m] = monthPick.value.split('-').map(Number);
          render(currentGrid, y, m - 1);
          
          showModal(`成功匯入 ${markersAdded} 個新標記同 ${notesAdded} 個新備註。`);
          
      } catch (e) {
          console.error("Import failed:", e);
          showModal("匯入失敗，請檢查文字格式是否正確。");
      }
  });


  // --- 初始 Render ---
  render(currentGrid, startYear, startMonthIndex);
});
</script>
</body>
</html>


